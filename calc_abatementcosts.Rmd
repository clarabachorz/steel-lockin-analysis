```{R setup, include = FALSE}
path <- "C:/Users/claraba/Documents/PhD_work/Papers/SteelREMIND/Analysis/"
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(
    root.dir = path
    )


library(ggplot2)
library(gdx)
require(dplyr)
options(dplyr.summarise.inform = FALSE)
library(tidyr)
library(pals)
library(stringr)
library("quitte")
library(zoo)
library(purrr)
library(openxlsx)
library(rlang)
```

```{R read data, include = FALSE}
lockin <- read.csv("./inputdata/other/lcop_avg_lockin.csv")
# lockin <- read.csv("./inputdata/other/lcop_avg_npi.csv")

fast <- read.csv("./inputdata/other/lcop_avg_fasttrans.csv")
# fast <- read.csv("./inputdata/other/lcop_avg_lockin.csv")

fast_mif <- read.quitte("inputdata/mif/REMIND_generic_FastTransition-PkBudg820.mif") 
# fast_mif <- read.quitte("inputdata/mif/REMIND_generic_TransitionwLockIn-PkBudg820.mif")

lockin_mif <- read.quitte("inputdata/mif/REMIND_generic_TransitionwLockIn-PkBudg820.mif") 
# lockin_mif <- read.quitte("inputdata/mif/REMIND_generic_TransitionwLockIn-NPi.mif")
```


```{R analyse}

# --- Helper functions for scenario data analysis ---

# Remove emission cost and filter period
# values are taken up to 2075, and later filtered when calculating cumulative costs
prepare_lcop_no_em <- function(df) {
    df %>%
        filter(!component == "Emission Cost") %>%
        filter(between(period, 2025, 2075)) %>%
        select(-color)
}

# Summarise total LCO by period and region
summarise_lcop_total <- function(df) {
    df %>%
        group_by(period, region) %>%
        summarise(value = sum(value, na.rm = TRUE)) %>%
        ungroup()
}

# Get total production from mif data
# values are taken up to 2075, and later filtered when calculating cumulative costs
get_total_production <- function(mif) {
    mif %>%
        filter(grepl("Production|Industry|Steel|+", variable, ignore.case = TRUE, fixed = TRUE)) %>%
        filter(unit == "Mt/yr") %>%
        filter(between(period, 2025, 2075)) %>%
        mutate(variable = gsub("Production|Industry|Steel|+", "", variable)) %>%
        mutate(variable = sub("^\\|\\|\\|\\+\\|", "", variable, fixed = FALSE)) %>%
        group_by(period, region) %>%
        summarise(total_production = sum(value, na.rm = TRUE)) %>%
        ungroup()
}

# Get total yearly CO2 emissions from mif data
get_total_emissions <- function(mif, colname) {
    mif %>%
        filter(grepl("Emi|CO2|Energy|Demand|Industry|Steel|+", variable, ignore.case = TRUE, fixed = TRUE)) %>%
        filter(between(period, 2025, 2075)) %>%
        select(-model) %>%
        group_by(period, region) %>%
        summarise(total_CO2_yearly = sum(value, na.rm = TRUE)) %>%
        ungroup() %>%
        select(period, region, total_CO2_yearly) %>%
        rename(!!colname := total_CO2_yearly)
}

# Calculate total costs (LCO * production)
calc_total_costs <- function(lcop_total, prod, cost_col) {
    lcop_total %>%
        left_join(prod, by = c("period", "region")) %>%
        mutate(total_cost = value * total_production) %>%
        select(-value, -total_production) %>%
        filter(between(period, 2025, 2075)) %>%
        rename(!!cost_col := total_cost)
}

# --- Calculate both scenarios ---

# Prepare data for both scenarios using the helper functions
lockin_lcop_no_em <- prepare_lcop_no_em(lockin)
fast_lcop_no_em   <- prepare_lcop_no_em(fast)

lockin_lcop_no_em_total <- summarise_lcop_total(lockin_lcop_no_em)
fast_lcop_no_em_total   <- summarise_lcop_total(fast_lcop_no_em)

lockin_mif_prod <- get_total_production(lockin_mif)
fast_mif_prod   <- get_total_production(fast_mif)

lockin_mif_em <- get_total_emissions(lockin_mif, "yrCO2_lockin")
fast_mif_em   <- get_total_emissions(fast_mif, "yrCO2_fast")

lockin_costs <- calc_total_costs(lockin_lcop_no_em_total, lockin_mif_prod, "total_cost_lockin")
fast_costs   <- calc_total_costs(fast_lcop_no_em_total, fast_mif_prod, "total_cost_fast")

```

```{R adjust system cost with demand change}


# account for differences in demand between 2 scenarios
# by multiplying average cost of the two scenarios with demand difference
calc_demand_adjustment <- function(lockin_mif, fast_mif, fast_mif_prod, lockin_mif_prod) {
    
    avg_price <- lockin_mif %>%
        mutate(scenario = "Scen1") %>%
        filter(grepl("CES Function|CES Price|ue_steel_primary", 
                    variable, ignore.case = TRUE, fixed = TRUE)) %>%
        bind_rows(fast_mif %>% 
                    filter(grepl("CES Function|CES Price|ue_steel_primary", 
                                variable, ignore.case = TRUE, fixed = TRUE)) %>%
                    mutate(scenario = "Scen2")) %>%
        #2075 is needed as a time step, since it provides the upper timestep.
        filter(between(period, 2025, 2075)) %>% 
        select(-model, -unit) %>%
        mutate(value = value * 1000) %>% #convert to USD/t
        pivot_wider(names_from = scenario, values_from = value) %>% 
        mutate(price_average = (Scen2+Scen1)/2) %>% 
        select(period, region, price_average)
    #calculate production difference
    prod_diff <- fast_mif_prod %>%
        left_join(lockin_mif_prod, by = c("period", "region")) %>%
        #production of lock-in scen - production of fast transition scen
        #(in Mt of steel)
        mutate(prod_diff = total_production.y - total_production.x) %>%
        select(period, region, prod_diff)

    #multiply. USD/t * Mt = million USD
    demand_value <- avg_price %>%
        left_join(prod_diff, by = c("period", "region")) %>%
        mutate(demand_value = price_average * prod_diff) %>%
        select(period, region, demand_value)
}


#add these costs to the fast transition scenario 
# ("loss in societal value due to producing less steel / steel reduced demand comes at an extra cost")
add_demand_adjustment <- function(fast_costs, demand_value) {
    fast_costs %>%
        left_join(demand_value, by = c("period", "region")) %>%
        mutate(total_cost_fast = total_cost_fast + demand_value) %>%
        select(-demand_value)
}

demand_value <- calc_demand_adjustment(lockin_mif, fast_mif, fast_mif_prod, lockin_mif_prod)
fast_costs_wdemandadjustment <- add_demand_adjustment(fast_costs, demand_value)

```
```{R get diagnostics df}

# info df can be used to check the different steps of the calculation
get_info_df <- function(fast_lcop_no_em_total, lockin_lcop_no_em_total, 
                    fast_mif_prod, lockin_mif_prod, fast_mif_em, lockin_mif_em) {
    info_df <- fast_lcop_no_em_total %>%
        rename(lcop_fast = value) %>%
        left_join(lockin_lcop_no_em_total %>%
                rename(lcop_npi = value), 
                by = c("period", "region")) %>%
        left_join(fast_mif_prod %>%
                select(period, region, total_production) %>%
                rename(total_production_fast = total_production), 
                by = c("period", "region")) %>%
        left_join(lockin_mif_prod %>%
                select(period, region, total_production) %>%
                rename(total_production_npi = total_production), 
                by = c("period", "region")) %>% 
        left_join(fast_mif_em,
                by = c("period", "region")) %>%
        left_join(lockin_mif_em %>%
                    rename(yrCO2_npi = yrCO2_lockin),
                    by = c("period", "region")) %>%
        arrange(region, period)

    #save to excel
    # write.xlsx(info_df, "info_df.xlsx")
}
```

```{R discount costs}
discount_rate <- 0.07
start_date <- 2025
end_date <- 2070


calc_cumulated_discounted_sum <- function(lockin_mif_em, start_date, end_date, discount_rate, col_to_sum, final_col_name) {
    lockin_mif_em %>%
        group_by(region) %>%
        complete(period = full_seq(period, 1)) %>%  # Fill every year
        arrange(region, period) %>%
        # in million USD, or in MtCO2
        mutate(value = !!sym(col_to_sum)) %>%
        fill(value, .direction = "down") %>%
        ungroup() %>%
        select(-all_of(col_to_sum)) %>%
        # correct time period. 2025 = 2023-2028 in REMIND
        mutate(period = period - 2) %>% 
        filter(between(period, start_date, end_date)) %>%
        arrange(region, period) %>%
        #discount rate set to 0 for emissions
        mutate(discounted_value = value / ((1 + discount_rate) ^ (period - start_date))) %>%
        group_by(region) %>%
        summarise(!!final_col_name := sum(discounted_value, na.rm = TRUE)) %>%
        ungroup()
}

# still in million USD
# we discount these costs
lockin_costs_total_discounted <- calc_cumulated_discounted_sum(lockin_costs,
                                                            start_date, end_date,
                                                            discount_rate,
                                                            "total_cost_lockin", "total_cost_lockin")

fast_costs_total_discounted <- calc_cumulated_discounted_sum(fast_costs_wdemandadjustment,
                                                            start_date, end_date,
                                                            discount_rate,
                                                            "total_cost_fast", "total_cost_fast")

# we only discount costs, not emissions. Therefore discount rate is 0.
lockin_mif_em_total <- calc_cumulated_discounted_sum(lockin_mif_em, 
                                    start_date, end_date,
                                    discount_rate = 0,
                                    "yrCO2_lockin", "total_CO2_lockin")

fast_mif_em_total <- calc_cumulated_discounted_sum(fast_mif_em,
                                start_date, end_date,
                                discount_rate = 0, 
                                "yrCO2_fast", "total_CO2_fast")

# Calculate fscp based on results
# Units: million USD / MtCO2 = USD/tCO2
fscp_df <- lockin_costs_total_discounted %>%
    left_join(fast_costs_total_discounted, by = "region") %>%
    left_join(lockin_mif_em_total, by = "region") %>%
    left_join(fast_mif_em_total, by = "region") %>% 
    mutate(fscp = (total_cost_fast - total_cost_lockin) / 
           (total_CO2_lockin - total_CO2_fast)) %>% 
    mutate(em_diff = total_CO2_lockin - total_CO2_fast)

# Aggregate regions according to region_to_aggr
aggregate_regions <- function(df, region_to_aggr) {
    grouped_df <- imap_dfr(region_to_aggr, function(regions, new_region) {
        df %>%
            filter(region %in% regions) %>%
            summarise(
                region = new_region,
                total_cost_lockin = sum(total_cost_lockin, na.rm = TRUE),
                total_cost_fast = sum(total_cost_fast, na.rm = TRUE),
                total_CO2_lockin = sum(total_CO2_lockin, na.rm = TRUE),
                total_CO2_fast = sum(total_CO2_fast, na.rm = TRUE)
            ) %>% 
            mutate(
                fscp = (total_cost_fast - total_cost_lockin) / 
                    (total_CO2_lockin - total_CO2_fast),
                em_diff = total_CO2_lockin - total_CO2_fast
            )
    })

    new_regions_flattened <- unlist(region_to_aggr, use.names = FALSE)
    fscp_df_grouped <- df %>%
        filter(!region %in% new_regions_flattened) %>%
        bind_rows(grouped_df)
}

region_to_aggr = list(
    "OASLAM" = c("OAS", "LAM"), #LAM emits more in fast transition. Grouping them gives fscp = 700
    "EUR+USA+JPN+REF" = c("EUR", "USA", "CAZ", "NEU", "REF", "JPN")
)

fscp_df_grouped <- aggregate_regions(fscp_df, region_to_aggr)

```

```{R plot}

df <- fscp_df_grouped %>%
    select(region, fscp, em_diff) %>%
    arrange(region) %>%
    # Filter out regions with more emissions in fast transition (only small regions)
    filter(em_diff > 0) %>%
    mutate(em_diff = em_diff / 1000) # Convert to GtCO2

# Sort by fscp from lower to higher
df <- df[order(df$fscp), ]
# Preserve region order based on sorted fscp
df$region <- factor(df$region, levels = df$region)
# Create cumulative x position for area plot
df$cum_em <- cumsum(df$em_diff)
df$xmin <- df$cum_em - df$em_diff
df$xmax <- df$cum_em

# plot abatement costs
p <- ggplot(df, aes(xmin = xmin, xmax = xmax, ymin = 0, ymax = fscp, fill = region)) +
  geom_rect(color = "black") +
  labs(
    # title = "Marginal abatement cost: from Extended Lock-in to Fast Transition",
    title = paste("Average abatement costs: from NPi to Fast Transition (discount rate:", discount_rate * 100, "%, dates:", start_date, "-", end_date, ")"),
    x = "Cumulative emission difference (GtCo2)",
    y = "Average abatement cost (USD/tCO2)"
  ) +
  theme_minimal() +
    scale_fill_manual(values = c(
      "CHA" = "#e41c23",
      "IND" = "#ff7f00",
      "EUR" = "#110a9a",
      "EUR+USA+JPN+REF" = "#4870b9",
      "OAS" = "#f6da23",
      "OASLAM" = "#f6da23",
      "NEU" = "#1ea6f0",
      "REF" = "#b2df8a",
      "USA" = "#33a02c", 
      "JPN" = "#f8f2f2",
      "LAM" = "#a65628",
      "SSA" = "#103b17",
      "MEA" = "#0bbda5"))
p
# ggsave("figs_temp/abatement_costs_steel_NPitoEL.png", p,bg = "white", width = 8, height = 6)
```