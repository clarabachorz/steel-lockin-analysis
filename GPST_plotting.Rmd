 ---
title: "BOF Steel-making Capacity Plot"
output: html_document
---

```{R setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# install.packages("ggplot2")

library(tidyverse)
library(ggplot2)
library(grid)
library(quitte)
# library(ggpattern)
require(gridExtra)

```

```{R readdata}
raw_data <- read.csv("inputdata/gspt/global_BOFcap.csv")

raw_age_data <- read.csv("inputdata/gspt/age_distribution.csv")

raw_age_data_region <- read.csv("inputdata/gspt/age_distribution_regions.csv")

df_production_bof <- read.csv("inputdata/worldsteel/bof_production.csv")
df_production_other <- read.csv("inputdata/worldsteel/other_production.csv")
df_production_eaf <- read.csv("inputdata/worldsteel/eaf_production.csv")

raw_regional_data <- read.csv("inputdata/gspt/BOF_capacity_perREMINDregion.csv")

```

```{R clean data}
clean_column_names <- function(name) {
  name <- gsub("\\.+", "_", name)
  name <- sub("_$", "", name)
}

### CLEAN UP CAPACITY DATA

data <- raw_data %>% 
  rename_all(clean_column_names) %>%
  select(-Region, -X5year_BOF_capacity_additions)

# Calculate Total net existing bof capacity: historic (old) cap additions- retirement of historic plants
# additional "Total_net_BOF_capacity_no_retirement_date" is capacity for which no dates are known. We simulate a linear decrease in net capacity instead.
data <- data %>%
  mutate(Total_retired_BOF_capacity_old = Total_retired_BOF_capacity - Total_retired_BOF_capacity_new_projects) %>%
  mutate(Total_BOF_capacity_additions_old = Total_BOF_capacity_additions - Total_BOF_capacity_additions_new_projects ) %>%
  mutate(Total_net_BOF_capacity_no_retirement_date = Total_BOF_capacity_additions_no_retirement_date - Total_retired_BOF_capacity_no_retirement_date) %>%
  mutate(Total_net_existing_BOF_capacity = Total_BOF_capacity_additions_old - Total_retired_BOF_capacity_old + Total_net_BOF_capacity_no_retirement_date )

# Get net BOF capacity additions (the ones that are operating). Split it into under construction or announcement subsets
data <- data %>%
  mutate(New_BOF_capacity_additions_still_operating = Total_BOF_capacity_additions_new_projects - Total_retired_BOF_capacity_new_projects) %>%
  mutate(New_BOF_capacity_additions_still_operating_under_construction = New_BOF_capacity_additions_still_operating - Total_net_BOF_capacity_additions_new_projects_announced_only) %>%
  rename(New_BOF_capacity_additions_still_operating_announcements = Total_net_BOF_capacity_additions_new_projects_announced_only)
  

# net BOF capacity additions (for new plants) if plants have one relining, or 2 relinings (lifetime of 2x relining or 3x relining)
# simply a complement to derive the fraction of these new plants that are under construction
data <- data %>%
  mutate(Total_net_BOF_capacity_additions_new_projects_2_relining_under_construction = Total_net_BOF_capacity_additions_new_projects_2_relining - Total_net_BOF_capacity_additions_new_projects_2_relining_announced_only) %>%
  mutate(Total_net_BOF_capacity_additions_new_projects_1_relining_under_construction = Total_net_BOF_capacity_additions_new_projects_1_relining - Total_net_BOF_capacity_additions_new_projects_1_relining_announced_only)


data_long <- data %>%
    pivot_longer(cols = -index, names_to = "Category", values_to = "Capacity")

data_NetBOFcap <- data %>%
    select("Remaining_BOF_capacity", "index") %>%
    pivot_longer(cols = -index, names_to = "Category", values_to = "Capacity")

#convert to Mtpa (/ 1000)
data_NetBOFcap$Capacity <- data_NetBOFcap$Capacity / 1000
data_long$Capacity <- data_long$Capacity / 1000

colnames(data)

### CLEAN UP AGE DATA

age_data <- raw_age_data %>%
  rename_all(clean_column_names) %>%
  mutate(Total_BOF_capacity = Total_BOF_capacity / 1000)

age_data_region <- raw_age_data_region %>%
  rename_all(clean_column_names) %>%
  mutate(Total_BOF_capacity = Total_BOF_capacity / 1000)

regional_data <- raw_regional_data %>%
  rename_all(clean_column_names) %>%
  select(Year, Region, Remaining_BOF_capacity, Total_BOF_capacity_additions, Total_BOF_capacity_additions_no_retirement_date, Yearly_BOF_Capacity_additions)
```


```{R plot}

data_long_filtered <- data_long %>%
  filter(Category %in% c("Total_net_existing_BOF_capacity",
          "Total_retired_BOF_capacity_new_projects",
          "Total_retired_BOF_capacity_custom_calculated_retirement_date",
          "New_BOF_capacity_additions_still_operating_under_construction",
          "New_BOF_capacity_additions_still_operating_announcements",
          "index"))


data_long_filtered$Category <- factor(data_long_filtered$Category, 
                            levels = c("Total_retired_BOF_capacity_new_projects",
                              "Total_retired_BOF_capacity_custom_calculated_retirement_date",
                              "New_BOF_capacity_additions_still_operating_under_construction",
                              "New_BOF_capacity_additions_still_operating_announcements",
                              "Total_net_existing_BOF_capacity"))


p <- ggplot(data_long_filtered, aes(x = factor(index), y = Capacity, fill = Category)) +
  geom_bar(stat = "identity", data = data_long_filtered) +
  scale_fill_manual(values = c("Total_retired_BOF_capacity_new_projects" = "pink",
                              "New_BOF_capacity_additions_still_operating_under_construction" = "#e41c7d",
                              "New_BOF_capacity_additions_still_operating_announcements" = "#b11d36",
                              "Total_retired_BOF_capacity_custom_calculated_retirement_date" = "grey",
                              "Total_net_existing_BOF_capacity" = "#454444"),
                    labels = c("Total_retired_BOF_capacity_new_projects" = "Fraction of new BF-BOFs\nrequiring retirement or reinvestment",
                              "New_BOF_capacity_additions_still_operating_under_construction" = "New BF-BOF project (under construction)",
                              "New_BOF_capacity_additions_still_operating_announcements" = "New BF-BOF project (announced)",
                              "Total_retired_BOF_capacity_custom_calculated_retirement_date" = "Fraction of operating BF-BOF\nrequiring retirement or reinvestment",
                              "Total_net_existing_BOF_capacity" = "Operating BF-BOF capacity"))+
  labs(x = "Time period", y = "Global BF-BOF steel-making capacity (Mtpa)", fill = "Bar Legend", color = "Line Legend") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

p + geom_line(data = data_NetBOFcap, aes(x = factor(index), y = Capacity, group = Category, color = "Remaining_BOF_capacity"), linewidth = 1.5) +
  scale_color_manual(values = c("Remaining_BOF_capacity" = "black"),
                     labels = c("Remaining_BOF_capacity" = "Net operating BF-BOF capacity")) +
  scale_x_discrete(breaks = seq(2000, 2050, by = 5)) +
  theme(legend.position = "right")

#ggsave("figs/BOF_capacity_plot.png", width = 10, height = 6, dpi = 300)
```

```{R plot2 capacity}
x_breaks <- seq(2000, 2080, by = 5)
data_long_filtered <- data_long %>%
  filter(Category %in% c(
          "Total_net_existing_BOF_capacity",
          "Additional_net_BOF_capacity_operating_2_relining",
          "Total_net_BOF_capacity_additions_new_projects_2_relining_under_construction",
          "Total_net_BOF_capacity_additions_new_projects_2_relining_announced_only",
          #"New_BOF_capacity_additions_still_operating_under_construction",
          #"New_BOF_capacity_additions_still_operating_announcements",
          "index"))


data_long_filtered$Category <- factor(data_long_filtered$Category, 
                            levels = c(
                              "Total_net_BOF_capacity_additions_new_projects_2_relining_announced_only",
                              "Total_net_BOF_capacity_additions_new_projects_2_relining_under_construction",
                              "Additional_net_BOF_capacity_operating_2_relining",
                              "Total_net_existing_BOF_capacity"))

#p <-
ggplot(data_long_filtered, aes(x = factor(index), y = Capacity, fill = Category)) +
  geom_bar(stat = "identity", data = data_long_filtered) +
  scale_fill_manual(values = c(
                              "Total_net_BOF_capacity_additions_new_projects_2_relining_under_construction" = "#e41c7d",
                              "Total_net_BOF_capacity_additions_new_projects_2_relining_announced_only" = "#b11d36",
                              "Additional_net_BOF_capacity_operating_2_relining" = "grey",
                              "Total_net_existing_BOF_capacity" = "#454444"
                              ),
                    labels = c("Total_net_BOF_capacity_additions_new_projects_2_relining_under_construction" = "New BF-BOF project (under construction)",
                              "Total_net_BOF_capacity_additions_new_projects_2_relining_announced_only" = "New BF-BOF project (announced)",
                              "Additional_net_BOF_capacity_operating_2_relining" = "Additional capacity remaining from operating projects\nif two BF relinings are carried out",
                              "Total_net_existing_BOF_capacity" = "Operating BF-BOF capacity"))+
  labs(x = "Time period", y = "Global BF-BOF steel-making capacity (Mtpa)", fill = "Bar Legend", color = "Line Legend") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks = x_breaks)

# p + geom_line(data = data_NetBOFcap, aes(x = factor(index), y = Capacity, group = Category, color = "Remaining_BOF_capacity"), linewidth = 1.5) +
#   scale_color_manual(values = c("Remaining_BOF_capacity" = "black"),
#                      labels = c("Remaining_BOF_capacity" = "Net operating BF-BOF capacity")) +
#   scale_x_discrete(breaks = seq(2000, 2050, by = 5)) +
#   theme(legend.position = "right")

# ggsave("figs/BOF_capacity_plot_w2relining.png", width = 10, height = 6, dpi = 300)
```

```{R calc emissions}

data_long_filtered_em <- data_long %>%
  filter(Category %in% c(
          "Total_net_existing_BOF_capacity",
          "Additional_net_BOF_capacity_operating_1_relining",
          "Total_net_BOF_capacity_additions_new_projects_1_relining_announced_only",
          "Total_net_BOF_capacity_additions_new_projects_1_relining_under_construction",
          "Additional_cumulative_capacity_to_meet_gov_target",
          "index")) %>%
  filter(index >= 2020 & index <2071) %>%
  # mutate(Emissions = Capacity * 0.8 * 2.3) %>% #0.8 capacity factor, 2.3 tCO2/t steel. Unit is MtCO2/yr
  mutate(Emissions = ifelse(grepl("new_projects", Category), Capacity * 0.8 * 2, Capacity * 0.8 * 2.3)) #new additions are BAT = 2 tCO2/t steel

#take wide format to calculate cumulative caps
data_wide_em <- data_long_filtered_em %>%
  select(-Capacity) %>%
  filter(index >= 2025 & index <2071) %>%
  pivot_wider(names_from = Category, values_from = Emissions)

#clean df
data_wide_em[is.na(data_wide_em)] <- 0

#calculate cumulative emissions
data_wide_em_cumu <- data_wide_em %>%
  mutate(Cumu_oldBOF = cumsum(Total_net_existing_BOF_capacity)) %>%
  mutate(Cumu_oldBOF_1relining = cumsum(Total_net_existing_BOF_capacity + 
                                     Additional_net_BOF_capacity_operating_1_relining)) %>%
  mutate(Cumu_oldBOF_andnew = cumsum(Total_net_existing_BOF_capacity +
                                              Additional_net_BOF_capacity_operating_1_relining +
                                              Total_net_BOF_capacity_additions_new_projects_1_relining_announced_only +
                                              Total_net_BOF_capacity_additions_new_projects_1_relining_under_construction)) %>%
  mutate(Cumu_oldBOF_new_govtargets = cumsum(Total_net_existing_BOF_capacity +
                                              Additional_net_BOF_capacity_operating_1_relining +
                                              Total_net_BOF_capacity_additions_new_projects_1_relining_announced_only +
                                              Total_net_BOF_capacity_additions_new_projects_1_relining_under_construction +
                                              Additional_cumulative_capacity_to_meet_gov_target)) %>%
  select(index, Cumu_oldBOF,Cumu_oldBOF_1relining,Cumu_oldBOF_andnew, Cumu_oldBOF_new_govtargets)

# annoyingly, this needs to be in long format to work
data_long_em_cumu <- data_wide_em_cumu %>%
  pivot_longer(cols = -index, names_to = "Category", values_to = "Emissions")

data_long_em_cumu$Category <- factor(data_long_em_cumu$Category, 
                            levels = c(
                              "Cumu_oldBOF_new_govtargets",
                              "Cumu_oldBOF_andnew",
                              "Cumu_oldBOF_1relining",
                              "Cumu_oldBOF"))



```

```{R plot emissions}
x_breaks <- seq(2020, 2075, by = 5)


data_long_filtered_em <- data_long_filtered_em %>%
  filter(Category != "Additional_cumulative_capacity_to_meet_gov_target")

data_long_em_cumu <- data_long_em_cumu %>% 
  filter(Category != "Cumu_oldBOF_new_govtargets")

data_long_filtered_em$Category <- factor(data_long_filtered_em$Category, 
                            levels = c(
                              # "Additional_cumulative_capacity_to_meet_gov_target",
                              "Total_net_BOF_capacity_additions_new_projects_1_relining_announced_only",
                              "Total_net_BOF_capacity_additions_new_projects_1_relining_under_construction",  
                              "Additional_net_BOF_capacity_operating_1_relining",
                              "Total_net_existing_BOF_capacity"))

p <- ggplot(data_long_filtered_em, aes(x = factor(index), y = Emissions, fill = Category)) +
  geom_bar(stat = "identity", data = data_long_filtered_em) +
  scale_fill_manual(values = c(
                              # "Additional_cumulative_capacity_to_meet_gov_target" = "#8420f0",
                              "Total_net_BOF_capacity_additions_new_projects_1_relining_under_construction" = "#e41c7d",
                              "Total_net_BOF_capacity_additions_new_projects_1_relining_announced_only" = "#b11d36",
                              "Additional_net_BOF_capacity_operating_1_relining" = "grey",
                              "Total_net_existing_BOF_capacity" = "#454444"
                              ),
                    labels = c(
                              # "Additional_cumulative_capacity_to_meet_gov_target" = "Additional capacity if 2030 government\ntargets are met only with BF-BOFs",
                              "Total_net_BOF_capacity_additions_new_projects_1_relining_under_construction" = "New BF-BOF project\n(under construction)",
                              "Total_net_BOF_capacity_additions_new_projects_1_relining_announced_only" = "New BF-BOF project\n(announced)",
                              "Additional_net_BOF_capacity_operating_1_relining" = "Operating BF-BOF capacity, assuming\none BF relining (lifetime of 35 years)",
                              "Total_net_existing_BOF_capacity" = "Operating BF-BOF capacity, assuming\nplants undergo no BF relinings\nafter 2025"))+
  labs(x = "Time period", y = "Global yearly emissions from BF-BOF steel-making (MtCO2/yr)", fill = "Bar Legend", color = "Line Legend")

scale_factor <- 22.5

p <- p + 
  geom_line(data = data_long_em_cumu, aes(x = factor(index), y = Emissions / scale_factor, group = Category, color = Category), linewidth = 1.3) +#, color = "black", linetype = "dashed") #+
  scale_color_manual(
    values = c(
      "Cumu_oldBOF_1relining" = "grey",
      "Cumu_oldBOF_andnew" = "#b11d36",
      "Cumu_oldBOF" = "#454444" #,
      # "Cumu_oldBOF_new_govtargets" = "#8420f0"
    ),
    labels = c(
      "Cumu_oldBOF_1relining" = "Cumulative CO2 emissions from 2025,\nfrom operating BF-BOFs, if one\nBF relining takes place",
      "Cumu_oldBOF_andnew" = "Cumulative CO2 emissions from 2025,\nfrom operating, under construction and\nannounced BF-BOFs, if one BF relining\ntakes place",
      "Cumu_oldBOF" = "Cumulative CO2 emissions from 2025,\nfrom operating BF-BOFs, if no new\nrelinings take place after 2025" #,
      # "Cumu_oldBOF_new_govtargets" = "Cumulative CO2 emissions from 2025,\nfrom all BF-BOFs, if additional capacity\nis added to meet 2030 government\ntargets"
    )
  ) +
    scale_y_continuous( limits = c(0, 3000),
    name = "Global yearly emissions from BF-BOF steel-making\n(MtCO2/yr), barplot",
    sec.axis = sec_axis(~ . * scale_factor, name = "Cumulative CO2 Emissions from 2025,\nfrom BF-BOF steel-making (MtCO2, line plots)")
  ) +
  labs(caption = "*BF-BOF is used as a general term; however, a small subset of included BOF facilities operate\nwithout a BF or rely on alternative iron production methods."
        ) +
  # labs(color = "Line Legend") +
  scale_x_discrete(breaks = x_breaks) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
    text = element_text(size = 12),
    axis.title = element_text(size = 13),
    axis.text = element_text(size = 11),
    legend.title = element_text(size = 13),
    legend.text = element_text(size = 10),

    legend.key.height = unit(1.7, "cm"),
    legend.key.width = unit(0.7, "cm"),
    legend.spacing.y = unit(1.6, "cm"),
    legend.margin = margin(8, 8, 8, 8)) +
  guides(
    fill = guide_legend(
      byrow = TRUE,
      title = "Bar Legend",
      keyheight = unit(1.4, "cm"),
      ),
    group = guide_legend(
      byrow = TRUE,
      title = "Line Legend",
      keyheight = unit(2, "cm"),
      )
    )
#add annotations and arrows
p <- p +
  geom_segment(aes(
    x = "2069", xend = "2069",
    y = max(data_long_em_cumu$Emissions[data_long_em_cumu$Category == "Cumu_oldBOF"]) / scale_factor, 
    yend = max(data_long_em_cumu$Emissions[data_long_em_cumu$Category == "Cumu_oldBOF_1relining"]) / scale_factor
  ), arrow = arrow(length = unit(0.4, "cm")), color = "black") +
  
  geom_segment(aes(
    x = "2069", xend = "2069",
    y = max(data_long_em_cumu$Emissions[data_long_em_cumu$Category == "Cumu_oldBOF_1relining"]) / scale_factor, 
    yend = max(data_long_em_cumu$Emissions[data_long_em_cumu$Category == "Cumu_oldBOF_andnew"]) / scale_factor
  ), arrow = arrow(length = unit(0.4, "cm")), color = "black") +

  # geom_segment(aes(
  #   x = "2069", xend = "2069",
  #   y = max(data_long_em_cumu$Emissions[data_long_em_cumu$Category == "Cumu_oldBOF_andnew"]) / scale_factor, 
  #   yend = max(data_long_em_cumu$Emissions[data_long_em_cumu$Category == "Cumu_oldBOF_new_govtargets"]) / scale_factor
  # ), arrow = arrow(length = unit(0.4, "cm")), color = "black") +
  
  annotate("text", x = "2069", y = (max(data_long_em_cumu$Emissions[data_long_em_cumu$Category == "Cumu_oldBOF_1relining"]) + 
                                max(data_long_em_cumu$Emissions[data_long_em_cumu$Category == "Cumu_oldBOF"])) / (2 * scale_factor), 
           label = "Effect of one\nBF relining\nleading to a\nplant lifetime\nof 35 years", hjust = 1.2,vjust = 0.4,
            lineheight = 0.9, size = 3.2) +
  
  annotate("text", x = "2069", y = (max(data_long_em_cumu$Emissions[data_long_em_cumu$Category == "Cumu_oldBOF_1relining"]) + 
                                max(data_long_em_cumu$Emissions[data_long_em_cumu$Category == "Cumu_oldBOF_andnew"])) / (2 * scale_factor), 
           label = "Add planned\nand under\nconstruction\nBF-BOFs", hjust = 1.2,vjust = 0.4,
            lineheight = 0.9, size = 3.2) 
            # +
  
  # annotate("text", x = "2069", y = (max(data_long_em_cumu$Emissions[data_long_em_cumu$Category == "Cumu_oldBOF_andnew"]) + 
  #                               max(data_long_em_cumu$Emissions[data_long_em_cumu$Category == "Cumu_oldBOF_new_govtargets"])) / (2 * scale_factor),
  #           label = "If 2030\ngovernment targets\nare reached using\nnew BF-BOFs",
  #           hjust = 1.17, vjust = 0.7,
  #           lineheight = 0.9, size = 3.2)
p
ggsave("figs/BOF_emissions_plot_1relinings_nogovtargets.png", width = 11, height = 8, dpi = 300)
```


```{R calc em test}

data_long <- data_long %>%
  filter(Category %in% c(
          "Total_net_existing_BOF_capacity",
          "Additional_net_BOF_capacity_operating_2_relining",
          "Additional_net_BOF_capacity_operating_1_relining",
          "New_BOF_capacity_additions_still_operating_under_construction",
          "New_BOF_capacity_additions_still_operating_announcements",
          "Total_net_BOF_capacity_additions_new_projects_2_relining_under_construction",
          "Total_net_BOF_capacity_additions_new_projects_2_relining_announced_only",
          "Additional_cumulative_capacity_to_meet_gov_target",
          "index"))

data_long_filtered_em <- data_long %>%
  filter(Category %in% c(
          "Total_net_existing_BOF_capacity",
          "Additional_net_BOF_capacity_operating_2_relining",
          "New_BOF_capacity_additions_still_operating_under_construction",
          "New_BOF_capacity_additions_still_operating_announcements",
          "Total_net_BOF_capacity_additions_new_projects_2_relining_under_construction",
          "Total_net_BOF_capacity_additions_new_projects_2_relining_announced_only",
          "Additional_cumulative_capacity_to_meet_gov_target",
          "index")) %>%
  filter(index >= 2020) %>%
  # mutate(Emissions = Capacity * 0.8 * 2.3) %>% #0.8 capacity factor, 2.3 tCO2/t steel. Unit is MtCO2/yr
  mutate(Emissions = ifelse(grepl("New_BOF_capacity_additions", Category), Capacity * 0.8 * 2, Capacity * 0.8 * 2.3)) #new additions are BAT = 2 tCO2/t steel


#take wide format to calculate cumulative caps
data_wide_em <- data_long_filtered_em %>%
  select(-Capacity) %>%
  filter(index >= 2025 & index <2081) %>%
  pivot_wider(names_from = Category, values_from = Emissions)

#clean df
data_wide_em[is.na(data_wide_em)] <- 0

#calculate cumulative emissions
data_wide_em_cumu <- data_wide_em %>%
  mutate(Cumu_oldBOF = cumsum(Total_net_existing_BOF_capacity)) %>%
  mutate(Cumu_oldBOF_andnew = cumsum(Total_net_existing_BOF_capacity + 
                                    New_BOF_capacity_additions_still_operating_announcements + 
                                    New_BOF_capacity_additions_still_operating_under_construction)) %>%
  mutate(Cumu_oldBOF_2relining = cumsum(Total_net_existing_BOF_capacity +
                                              New_BOF_capacity_additions_still_operating_announcements + 
                                              New_BOF_capacity_additions_still_operating_under_construction +
                                              Additional_net_BOF_capacity_operating_2_relining)) %>%
    mutate(Cumu_oldBOF_andnew_2relining = cumsum(Total_net_existing_BOF_capacity +
                                              Total_net_BOF_capacity_additions_new_projects_2_relining_under_construction+
                                              Total_net_BOF_capacity_additions_new_projects_2_relining_announced_only+
                                              Additional_net_BOF_capacity_operating_2_relining)) %>%
    mutate(Cumu_additionalGovtargets = Cumu_oldBOF_andnew_2relining +
                                      cumsum(Additional_cumulative_capacity_to_meet_gov_target)) %>%
  select(index, Cumu_oldBOF,Cumu_oldBOF_andnew,Cumu_oldBOF_2relining,Cumu_oldBOF_andnew_2relining, Cumu_additionalGovtargets)

# annoyingly, this needs to be in long format to work
data_long_em_cumu <- data_wide_em_cumu %>%
  pivot_longer(cols = -index, names_to = "Category", values_to = "Emissions")
```
```{R plot complex 2 relinings}

#x ticks
x_breaks <- seq(2020, 2080, by = 5)

data_long_filtered_em <- data_long_filtered_em %>%
  filter(Category %in% c(
          "Total_net_existing_BOF_capacity",
          "Additional_net_BOF_capacity_operating_2_relining",
          "Total_net_BOF_capacity_additions_new_projects_2_relining_under_construction",
          "Total_net_BOF_capacity_additions_new_projects_2_relining_announced_only",
          "Additional_cumulative_capacity_to_meet_gov_target",
          "index"))

data_long_em_cumu_simple <- data_long_em_cumu %>%
  filter(Category %in% c(
    "Cumu_oldBOF","Cumu_oldBOF_2relining","Cumu_oldBOF_andnew_2relining", "Cumu_additionalGovtargets")
  ) %>%
  mutate(LineCategory = Category)

data_long_filtered_em$Category <- factor(data_long_filtered_em$Category, 
                            levels = c(
                              "Additional_cumulative_capacity_to_meet_gov_target",
                              "Total_net_BOF_capacity_additions_new_projects_2_relining_announced_only",
                              "Total_net_BOF_capacity_additions_new_projects_2_relining_under_construction",
                              "Additional_net_BOF_capacity_operating_2_relining",
                              "Total_net_existing_BOF_capacity"))

p1 <- ggplot(data_long_filtered_em, aes(x = factor(index), y = Emissions, fill = Category)) +
  geom_bar(stat = "identity", data = data_long_filtered_em) +
  scale_fill_manual(values = c("Additional_cumulative_capacity_to_meet_gov_target" = "#8420f0",
                              "Total_net_BOF_capacity_additions_new_projects_2_relining_under_construction" = "#e41c7d",
                              "Total_net_BOF_capacity_additions_new_projects_2_relining_announced_only" = "#b11d36",
                              "Additional_net_BOF_capacity_operating_2_relining" = "grey",
                              "Total_net_existing_BOF_capacity" = "#454444"
                              ),
                    labels = c("Additional_cumulative_capacity_to_meet_gov_target" = "Additional capacity if government\ntargets are met only with BF-BOFs",
                              "Total_net_BOF_capacity_additions_new_projects_2_relining_under_construction" = "New BF-BOF project\n(under construction)",
                              "Total_net_BOF_capacity_additions_new_projects_2_relining_announced_only" = "New BF-BOF project\n(announced)",
                              "Additional_net_BOF_capacity_operating_2_relining" = "Operating BF-BOF capacity, assuming\ntwo BF relinings (minimum lifetime of\n45 years).",
                              "Total_net_existing_BOF_capacity" = "Operating BF-BOF capacity, assuming\nplants undergo no BF relinings\nafter 2025."))+
  labs(x = "Time period", y = "Global yearly emissions from BF-BOF steel-making (MtCO2/yr)", fill = "Bar Legend", color = "Line Legend") +
  scale_x_discrete(breaks = x_breaks)
  

scale_factor <- 30

p1 <- p1 + 
  geom_line(data = data_long_em_cumu_simple, aes(x = factor(index), y = Emissions / scale_factor, group = LineCategory, color = LineCategory), linewidth = 1.3) +#, color = "black", linetype = "dashed") #+
  scale_color_manual(
    values = c(
      "Cumu_oldBOF" = "#454444",
      "Cumu_oldBOF_2relining" = "grey",
      "Cumu_oldBOF_andnew_2relining" = "#b11d36",
      "Cumu_additionalGovtargets" = "#8420f0"
    ),
    labels = c(
      "Cumu_oldBOF" = "Cumulative CO2 emissions,\nfrom operating BF-BOFs, if no new\nrelinings take place after 2025",
      "Cumu_oldBOF_2relining" = "Cumulative CO2 emissions,\nfrom operating BF-BOFs, if two BF\nrelinings take place",
      "Cumu_oldBOF_andnew_2relining" = "Cumulative CO2 emissions,\nfrom operating, under construction and\nannounced BF-BOFs, if two BF\nrelinings take place",
      "Cumu_additionalGovtargets" = "Cumulative CO2 emissions,\nfrom all BF-BOFs, if additional capacity\nis added to meet government targets"
    )
  ) +
    scale_y_continuous( limits = c(0, 3000),
    name = "Global yearly emissions from BF-BOF steel-making\n(MtCO2/yr), barplot",
    sec.axis = sec_axis(~ . * scale_factor, name = "Cumulative CO2 Emissions from 2020,\nfrom BF-BOF steel-making (MtCO2, lineplots)")
  ) +
  labs(caption = "*BF-BOF is used as a general term; however, a small subset of included BOF facilities operate\nwithout a BF or rely on alternative iron production methods."
        ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
    text = element_text(size = 12),
    axis.title = element_text(size = 13),
    axis.text = element_text(size = 11),
    legend.title = element_text(size = 13),
    legend.text = element_text(size = 10),

    legend.key.height = unit(1.7, "cm"),
    legend.key.width = unit(0.7, "cm"),
    legend.spacing.y = unit(1.6, "cm"),
    legend.margin = margin(8, 8, 8, 8)) +
  guides(
    fill = guide_legend(
      byrow = TRUE,
      title = "Bar Legend",
      keyheight = unit(1.4, "cm"),
      ),
    group = guide_legend(
      byrow = TRUE,
      title = "Line Legend",
      keyheight = unit(2, "cm"),
      )
    )

#add annotations and arrows
p1 <- p1 +
  geom_segment(aes(
    x = "2079", xend = "2079",
    y = max(data_long_em_cumu_simple$Emissions[data_long_em_cumu_simple$Category == "Cumu_oldBOF_2relining"]) / scale_factor, 
    yend = max(data_long_em_cumu_simple$Emissions[data_long_em_cumu_simple$Category == "Cumu_oldBOF_andnew_2relining"]) / scale_factor
  ), arrow = arrow(length = unit(0.4, "cm")), color = "black") +
  geom_segment(aes(
    x = "2079", xend = "2079",
    y = max(data_long_em_cumu_simple$Emissions[data_long_em_cumu_simple$Category == "Cumu_oldBOF_andnew_2relining"]) / scale_factor, 
    yend = max(data_long_em_cumu_simple$Emissions[data_long_em_cumu_simple$Category == "Cumu_additionalGovtargets"]) / scale_factor
  ), arrow = arrow(length = unit(0.4, "cm")), color = "black") +
  geom_segment(aes(
    x = "2079", xend = "2079",
    y = max(data_long_em_cumu_simple$Emissions[data_long_em_cumu_simple$Category == "Cumu_oldBOF"]) / scale_factor, 
    yend = max(data_long_em_cumu_simple$Emissions[data_long_em_cumu_simple$Category == "Cumu_oldBOF_2relining"]) / scale_factor
  ), arrow = arrow(length = unit(0.4, "cm")), color = "black") +
  annotate("text", x = "2080",
          y = (max(data_long_em_cumu_simple$Emissions[data_long_em_cumu_simple$Category == "Cumu_oldBOF_andnew_2relining"]) + 
               max(data_long_em_cumu_simple$Emissions[data_long_em_cumu_simple$Category == "Cumu_oldBOF_2relining"])) / (2 * scale_factor), 
           label = str_wrap("Add planned and under construction BF-BOFs ", width = 17),
           hjust = 1.4, vjust = 0.4,
           lineheight = 0.9, size = 3.5) +
  annotate("text", x = "2080",
          y = (max(data_long_em_cumu_simple$Emissions[data_long_em_cumu_simple$Category == "Cumu_additionalGovtargets"]) + 
               max(data_long_em_cumu_simple$Emissions[data_long_em_cumu_simple$Category == "Cumu_oldBOF_andnew_2relining"])) / (2 * scale_factor), 
          label = str_wrap("If 2030 government targets are reached using new BF-BOFs", width = 20),
          hjust = 1.25, vjust = 0.6,
           lineheight = 0.9, size = 3.5) +
  annotate("text", x = "2079",
          y = (max(data_long_em_cumu_simple$Emissions[data_long_em_cumu_simple$Category == "Cumu_oldBOF_2relining"]) + 
              max(data_long_em_cumu_simple$Emissions[data_long_em_cumu_simple$Category == "Cumu_oldBOF"])) / (2 * scale_factor), 
           label = str_wrap("Effect of two BF relinings leading to a plant lifetime of 45 years", width = 16),
           hjust = 1.2, vjust = 0.4,
           lineheight = 0.9, size = 3.5)
p1
# ggsave("figs/BOF_emissions_plot_2relinings.png", width = 11, height = 8, dpi = 300)
```

```{R combine 1 and 2 relining plots}

grid.arrange(p, p1, ncol = 1, nrow = 2)
g <- arrangeGrob(p, p1, ncol = 1, nrow = 2)
ggsave("figs_temp/BOF_combine_relinings.png",g, width = 11, height = 12, dpi = 300)
```
```{R plot age distribution, regions}

#### I THINK THIS GOES HERE
#clean up age data df: missing ages are 0.
complete_ages <- data.frame(Age = 0:173)
age_data <- merge(complete_ages, age_data, by = "Age", all.x = TRUE)

age_data$Number_of_plants[is.na(age_data$Number_of_plants)] <- 0
age_data$Total_BOF_capacity[is.na(age_data$Total_BOF_capacity)] <- 0

#calculate cumulative capacity (age data)
cumu_cap_age <- age_data %>%
  mutate(Cumu_Total_BOF_capacity = cumsum(Total_BOF_capacity)) %>%
  mutate(Cumu_BOF_capacity_percent = Cumu_Total_BOF_capacity / sum(Total_BOF_capacity) * 100) %>%
  select(Age, Cumu_Total_BOF_capacity, Cumu_BOF_capacity_percent)
#####

grouping =  5#years

age_data_grouped <- age_data %>%
  mutate(Age_Group = case_when(
    Age >= 125 ~ "125+",  # Grouping all 81+ together
    TRUE ~ paste0(floor(Age / grouping) * grouping, "-", floor(Age / grouping) * grouping + grouping -1)
  )) %>%
  group_by(Age_Group) %>%
  summarise(
    Total_Capacity = sum(Total_BOF_capacity)
  ) %>%
  mutate(Age_Group = factor(Age_Group, levels = c(
    paste0(seq(0, 124, by = grouping), "-", seq(grouping-1, 124 + grouping -1, by = grouping)), "125+"
  )))

# grouping regional age data
age_data_region_grouped <- age_data_region %>%
  mutate(Age_Group = case_when(
    Age >= 125 ~ "125+",
    TRUE ~ paste0(floor(Age / grouping) * grouping, "-", floor(Age / grouping) * grouping + grouping - 1)
  )) %>%
  group_by(Age_Group, Region) %>%
  summarise(
    Regional_Capacity = sum(Total_BOF_capacity)
  ) %>%
  mutate(Age_Group = factor(Age_Group, levels = levels(age_data_grouped$Age_Group)))


#grouping cumu capacity data
cumu_cap_grouped <- cumu_cap_age %>%
  mutate(Age_Group = case_when(
    Age >= 125 ~ "125+",
    TRUE ~ paste0(floor(Age / grouping) * grouping, "-", floor(Age / grouping) * grouping + grouping -1)
  )) %>%
  group_by(Age_Group) %>%
  summarise(Cumu_BOF_capacity_percent = max(Cumu_BOF_capacity_percent)) %>%  # Take max per group
  mutate(Age_Group = factor(Age_Group, levels = levels(age_data_grouped$Age_Group)))  # Align factor levels

# summarize regional capacities for each Age_Group
regional_capacity_sum <- age_data_region_grouped %>%
  group_by(Age_Group) %>%
  summarise(Total_Regional_Capacity = sum(Regional_Capacity))

# merge global and regional data
plot_data <- left_join(age_data_grouped, regional_capacity_sum, by = "Age_Group") %>%
  mutate(Rest_of_World_Capacity = Total_Capacity - ifelse(is.na(Total_Regional_Capacity), 0, Total_Regional_Capacity)) %>%
  select(-Total_Regional_Capacity)

# reshape the data for stacked bar plot
plot_data_long <- plot_data %>%
  gather(key = "Type", value = "Capacity", -Age_Group) %>%
  filter(Type != "Total_Capacity") %>%
  mutate(Type = ifelse(Type == "Rest_of_World_Capacity", "Rest of World", Type))

# add regional data to the long format data
plot_data_long <- bind_rows(
  plot_data_long,
  age_data_region_grouped %>%
    select(Age_Group, Region, Regional_Capacity) %>%
    rename(Type = Region, Capacity = Regional_Capacity)
)

region_labels <- c(
  "CHA" = "China",
  "IND" = "India",
  "JPN" = "Japan",
  "EUR+RUS" = "Europe, Russia and\nex-USSR countries",
  "Rest of World" = "Rest of World"
)
plot_data_long <- plot_data_long %>%
  mutate(Type = recode(Type, !!!region_labels))
#add cumu capacity data
plot_data_long <- left_join(plot_data_long, cumu_cap_grouped, by = "Age_Group")


#calculate max production
max_production <- max(plot_data_long$Avg_Production, na.rm = TRUE)
max_capacity <- max(plot_data$Total_Capacity, na.rm = TRUE)
scale_production <- max_capacity / max_production

# # Define x-position for manually drawn y-axis (right side)
# fake_y_axis_x <- length(unique(plot_data_long$Age_Group)) + 1

# # Define tick marks for Steel Production (manually determined)
# steel_tick_values <- seq(0, 2000, length.out = 5)
# scaled_steel_ticks <- steel_tick_values * scale_production 

age_group_positions <- as.numeric(factor(plot_data_long$Age_Group, levels = levels(plot_data_long$Age_Group)))


# plot
ggplot(plot_data_long, aes(x = Age_Group, y = Capacity, fill = Type)) +
  #more annotations: rectangle indicating increase in production
  annotate("rect", 
          xmin= unique(age_group_positions[plot_data_long$Age_Group == "15-19"])-0.4,
          xmax=unique(age_group_positions[plot_data_long$Age_Group == "25-29"])+0.4,
          ymin=0, ymax=Inf, alpha=0.4, fill="#e7ab04")+
    annotate("rect", 
          xmin= unique(age_group_positions[plot_data_long$Age_Group == "50-54"])-0.4,
          xmax=unique(age_group_positions[plot_data_long$Age_Group == "70-74"])+0.4,
          ymin=0, ymax=Inf, alpha=0.4, fill="#e7ab04")+
  geom_bar(stat = "identity") +
  geom_line(aes(y = Cumu_BOF_capacity_percent * max_capacity / 100, group = 1, color = "Cumulative Capacity"), size = 1) +
  # geom_line(aes(y = Avg_Production * (max_capacity / max_production), group = 1, color = "Steel production"), size = 1) +

  # annotation_custom(
  #   grob = linesGrob(gp = gpar(col = "red", lwd = 2)),
  #   xmin = fake_y_axis_x, xmax = fake_y_axis_x, ymin = -17, ymax = max_capacity+150
  # ) +
  # geom_segment(aes(x = fake_y_axis_x, xend = fake_y_axis_x+0.1, 
  #                  y = 0, yend = 0), 
  #              color = "red", size = 0.5) +
  # geom_segment(aes(x = fake_y_axis_x, xend = fake_y_axis_x+0.1, 
  #                  y = 500*(max_capacity / max_production) , yend = 500*(max_capacity / max_production)), 
  #              color = "red", size = 0.5) +
  # geom_segment(aes(x = fake_y_axis_x, xend = fake_y_axis_x+0.1, 
  #                  y = 1000*(max_capacity / max_production) , yend = 1000*(max_capacity / max_production)), 
  #              color = "red", size = 0.5) +
  # geom_segment(aes(x = fake_y_axis_x, xend = fake_y_axis_x+0.1, 
  #                  y = 1500*(max_capacity / max_production) , yend = 1500*(max_capacity / max_production)), 
  #              color = "red", size = 0.5) +
  # geom_segment(aes(x = fake_y_axis_x, xend = fake_y_axis_x+0.1, 
  #                  y = 2000*(max_capacity / max_production) , yend = 2000*(max_capacity / max_production)), 
  #              color = "red", size = 0.5) +
  # # Annotate Steel Production Tick Marks
  # annotate("text", x = fake_y_axis_x + 0.2, y = scaled_steel_ticks, 
  #          label = round(steel_tick_values, 1), color = "red", size = 3, hjust = 0) +
  # # Annotate Steel Production Axis Label
  # annotate("text", x = fake_y_axis_x + 2, y = (max_capacity+80) / 2, 
  #          label = "Steel Production (Mt)", color = "red", size = 4, angle = 270) +
  #text for yellow rects
  annotate("text", x = "50-54", y = max_capacity * 1.1,
          label = "Post-WW2 BF-BOF\nsurge, driven by Europe,\nJapan, Russia and\nex-USSR countries",
          color = "black", size = 3.5, hjust = 0.1, vjust = 0.2) +
  annotate("text", x = "15-19", y = max_capacity * 1.1,
          label = "Recent surge\nof BF-BOFs,\ndriven by China",
          color = "black", size = 3.5, hjust = 0.2, vjust = 0)+
  #expand_limits(x = fake_y_axis_x + 3) +
  theme_minimal() +
  labs(title = "Age Distribution of BF-BOF Plants",
       x = "Age Group (Years)",
       y = "Total Capacity (Mtpa)",
       fill = "Region") +
  guides(fill = guide_legend(title = "Region", nrow = 2)) +
  scale_y_continuous(name = "New annual BF-BOF capacity installed (Mtpa)",
                    limits = c(0, max_capacity+80),
                    sec.axis = sec_axis(~ . * 100 / max_capacity, name = "Cumulative Capacity (%)")) +
  scale_fill_viridis_d(option = "mako", begin = 0.2, end = 0.6, direction = -1) +
  theme_classic() +
  scale_color_manual(name = "Line Legend",
                      values = c("Cumulative Capacity" = "black"
                                #"Steel production" = "red"
                                ),
                      guide = guide_legend(nrow =1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        )


# ggsave("figs/BOF_age_distribution_plot_wregions_cumu.png", width = 10, height = 6, dpi = 300)
```

```{R calc regional capacity data}

region_labels <- c(
  "CHA" = "China",
  "SSA" = "Sub-saharan Africa",
  "IND" = "India",
  "USAEUR" = "USA, Europe, Russia,\nJapan and ex-USSR countries"
)

start_year = 1900
end_year = 2100

#load data for post 2030 capacity additions (projections)
#data gives production, so convert to capacity using 0.8 production factor
# given in Mt/yr
projected_cap_additions <- read.csv("inputdata/other/primary_steel_prod_default.csv") %>%
  select(region, period, value) %>%
  filter(period > 2030, period <= 2100) %>% #GEM capacity additions go up to 2035
  mutate(value = value / 0.8) %>% #convert to capacity
  group_by(region) %>%
  arrange(period) %>%
  mutate(cap_additions = value - lag(value)) %>% #calculate capacity additions
  mutate(cap_additions = ifelse(is.na(cap_additions), value, ifelse(cap_additions < 0, 0, cap_additions))) %>%
  mutate(cum_sum = cumsum(cap_additions)) %>%
  ungroup() %>% 
  select(region, period, cum_sum) %>%
  # show projections only for India and SSA
  filter(!(region %in% c("USA","EUR","REF","NEU","JPN", "CHA","World", "CAZ", "LAM", "MEA", "OAS"))) %>%
  # filter(!(region %in% c("World", "CAZ", "LAM", "MEA", "OAS"))) %>%
  rename(Region = region, Year = period, value = cum_sum)

#here, we add the capacity additions from plants with little data available ("no retirement date")
# they are already accounted for in Remaining_BOF_capacity
df_plot_capacity <- regional_data %>%
  mutate(Total_BOF_capacity_additions = Total_BOF_capacity_additions + Total_BOF_capacity_additions_no_retirement_date) %>%
  # select(-Total_BOF_capacity_additions, - Total_BOF_capacity_additions_no_retirement_date, -Remaining_BOF_capacity) %>%
  # rename(value = Yearly_BOF_Capacity_additions) %>%
  select(-Remaining_BOF_capacity, -Total_BOF_capacity_additions_no_retirement_date, -Yearly_BOF_Capacity_additions) %>%
  rename(value = Total_BOF_capacity_additions) %>%
  mutate(value = value /1000) %>%
  filter(case_when(Region %in% c("IND", "SSA") ~ Year < 2035,
                                            T  ~ Year <2100 )) %>%
  bind_rows(projected_cap_additions)


df_plot_capacity <- df_plot_capacity %>%
  pivot_wider(names_from = Region, values_from = value) %>%
  # mutate(INDOAS = IND + OAS) %>%
  mutate(USAEUR = USA + EUR + REF + NEU + JPN) %>%
  select(-OAS, -USA, -EUR, -REF, -NEU, -JPN, -CAZ, -LAM, -MEA) %>%
  pivot_longer(cols = c(CHA, USAEUR, SSA, IND)) %>%
  #projected values are given in 5y time steps. Remove the NAs that are inbetween
  filter(!(is.na(value)))

#need to add another value for 2100 for USAEUR and CHA
rows_to_add <- df_plot_capacity %>%
  filter(name %in% c("USAEUR", "CHA")) %>%
  group_by(name) %>%
  arrange(Year) %>%
  summarise(value = last(value)) %>%
  mutate(Year = 2100)

df_plot_capacity <- df_plot_capacity %>%
  bind_rows(rows_to_add) %>%
  mutate(Region = recode(name, !!!region_labels))

#label years after 2025
df_plot_capacity <- df_plot_capacity %>%
  mutate(segment = ifelse(Year < 2025, "Historic capacity", ifelse(Year < 2032,"New announcements","Projections")))

p <- ggplot() +
  geom_line(data=df_plot_capacity,
            aes(x=Year, y=value, colour=Region,linetype = segment), size = 1) +
  scale_linetype_manual(values = c("Historic capacity" = "solid", "New announcements" = "111111", "Projections" = "1343")) +
  scale_color_manual(values = c(
      "China" = "#e41c23",
      "Sub-saharan Africa" = "#06723e",
      "India" = "#ff7f00",
      "USA, Europe, Russia,\nJapan and ex-USSR countries" = "#110a9a"
    )) +
  theme_bw() +
labs(title = "Regional BF-BOF cumulative capacity additions\n(historical, new announcements as of June 2025\nand future projections)",
       x = "Year",
       y = "Cumulative BF-BOF capacity installed (Mtpa)",
       colour = "Region",
       linetype = "Segment") +
  scale_x_continuous(breaks = seq(start_year, end_year, by = 10),
                    limits = c(start_year,end_year)) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 11),
    # legend.position = "bottom",
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    #rotate xticks
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)
  ) +
  geom_vline(xintercept = 2025, linetype = "solid", size = 0.4 , color = "#565555") +
  # geom_rect(aes(xmin = 2025, xmax = end_year, ymin = 0, ymax = Inf), fill = "#6a6a6951", alpha = 0.2)
  geom_rect(aes(xmin = start_year, xmax = 2025, ymin = 0, ymax = Inf), fill = "#6a6a6951", alpha = 0.2)




p
# ggsave("figs_temp/BOF_regional_capacity_plot.png", p, width = 8, height = 6, dpi = 300)
```

```{R calc regional capacity ADDITIONS data}

region_labels <- c(
  "CHA" = "China",
  "SSA" = "Sub-saharan Africa",
  "IND" = "India",
  "USAEUR" = "USA, Europe, Russia,\nJapan and ex-USSR countries"
)

bins = 10
start_year = 1900
end_year = 2096

bin_years <- seq(start_year, end_year, by = bins)
#(period - 1900 - 5) / 5 to get index for correct bin year,
#add to df, group by bin year and sum. 

#load projected capacity additions
projected_cap_additions <- read.csv("inputdata/other/primary_steel_prod_default.csv") %>%
  select(region, period, value) %>%
  filter(period > 2030, period <= 2100) %>% #GEM capacity additions go up to 2035
  mutate(value = value / 0.8) %>% #convert to capacity
  group_by(region) %>%
  arrange(period) %>%
  mutate(cap_additions = value - lag(value)) %>% #calculate capacity additions
  mutate(cap_additions = ifelse(is.na(cap_additions), value, ifelse(cap_additions < 0, 0, cap_additions))) %>%
  ungroup() %>%
  select(region, period, cap_additions) %>%
  # show projections only for India and SSA
  filter(!(region %in% c("USA","EUR","REF","NEU","JPN", "CHA","World", "CAZ", "LAM", "MEA", "OAS"))) %>%
  rename(Region = region, Year = period, value = cap_additions)


#here, we add the capacity additions from plants with little data available ("no retirement date")
# they are already accounted for in Remaining_BOF_capacity
df_plot_capacity <- regional_data %>%
  mutate(Total_BOF_capacity_additions = Total_BOF_capacity_additions + Total_BOF_capacity_additions_no_retirement_date) %>%
  select(-Total_BOF_capacity_additions, - Total_BOF_capacity_additions_no_retirement_date, -Remaining_BOF_capacity) %>%
  rename(value = Yearly_BOF_Capacity_additions) %>%
  mutate(value = value /1000) %>%
  filter(case_when(Region %in% c("IND", "SSA") ~ Year < 2035,
                                            T  ~ Year <2100 )) %>%
  bind_rows(projected_cap_additions)

df_plot_capacity <- df_plot_capacity %>%
  pivot_wider(names_from = Region, values_from = value) %>%
  # mutate(INDOAS = IND + OAS) %>%
  mutate(USAEUR = USA + EUR + REF + NEU + JPN) %>%
  select(-OAS, -USA, -EUR, -REF, -NEU, -JPN, -CAZ, -LAM, -MEA) %>%
  pivot_longer(cols = c(CHA, USAEUR, SSA, IND)) %>%
  mutate(Region = recode(name, !!!region_labels)) %>% 
  mutate(Region = factor(Region, levels = c("Sub-saharan Africa", "India","China", "USA, Europe, Russia,\nJapan and ex-USSR countries"))) %>% 
  filter(!(is.na(value)))

df_plot_capacity <- df_plot_capacity %>%
  mutate(bin_year = bin_years[(Year - (start_year - bins))/bins]) %>%
  group_by(name, Region, bin_year) %>%
  summarise(value = sum(value)) %>%
  ungroup()

# print(df_plot_capacity %>% filter(Region == "India", bin_year > 2020))


#label years after 2025
df_plot_capacity <- df_plot_capacity %>%
  mutate(segment = ifelse(bin_year >= 2025, "New announcements", "Historic capacity"))

p <- ggplot() +
  geom_bar(data=df_plot_capacity,
            aes(x=bin_year, y=value, fill=Region),
            position = "stack", 
          stat="identity") +
  # scale_linetype_manual(values = c("Historic capacity" = "solid", "New announcements" = "22")) +
  scale_fill_manual(values = c(
      "China" = "#e41c23",
      "Sub-saharan Africa" = "#06723e",
      "India" = "#ff7f00",
      "USA, Europe, Russia,\nJapan and ex-USSR countries" = "#110a9a"
    )) +
  theme_bw() +
labs(title = "Regional BF-BOF capacity additions\n(historical, new announcements as of June 2025\nand future projections)",
       x = "Year",
       y = "BF-BOF capacity additions (Mtpa)",
       fill = "Region") +
  scale_x_continuous(breaks = seq(start_year, end_year, by = 10),
                    limits = c(start_year,end_year)) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 11),
    # legend.position = "bottom",
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    #rotate xticks
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)
  ) +
  geom_vline(xintercept = 2025, linetype = "solid", size = 0.4 , color = "#565555") +
  # geom_rect(aes(xmin = 2025, xmax = end_year, ymin = 0, ymax = Inf), fill = "#6a6a6951", alpha = 0.2)
  geom_rect(aes(xmin = start_year, xmax = 2025, ymin = 0, ymax = Inf), fill = "#6a6a6951", alpha = 0.15)



p
# ggsave("figs_temp/BOF_regional_capacity_additions_10y.png", p, width = 8, height = 6, dpi = 300)
```

```{R calc production data}

regions_to_filter <- c("USA", "EUR", "CHA", "IND", "OAS", "SSA", "REF", "NEU", "JPN")


df_production_regions <- df_production_bof %>%
  mutate(type = "bof") %>%
  bind_rows(df_production_eaf %>%
              mutate(type = "eaf") %>%
              filter(Region=="IND")
              ) %>%
  bind_rows(df_production_other %>%
              mutate(type = "other")) %>%
  rename_all(clean_column_names) %>%
  mutate(value = value / 1e6) #convert from t to Mt

#load projected production
projected_production <- read.csv("inputdata/other/primary_steel_prod_default.csv") %>%
  select(region, period, value) %>%
  filter(period > 2025, period <= 2100) %>% #production data goes up to 2022
  mutate(type = "bof") %>%
  rename(Region = region, Historic_Time = period)

#add new rows for India coal-DRI projections
new_rows <- data.frame(
  Historic_Time = c(2023, 2025, 2030, 2023),
  Region = c("IND", "IND", "IND", "IND"),
  value = c(50,40, 15, 60),
  type = c("eaf", "eaf", "eaf", "bof")
)

df_production_regions <- df_production_regions %>%
  bind_rows(projected_production) %>%
  bind_rows(new_rows)

```

```{R plot regional production data}

region_labels <- c(
  "CHA" = "China",
  "SSA" = "Sub-saharan Africa",
  "IND" = "India",
  "USAEUR" = "USA, Europe, Russia,\nJapan and ex-USSR countries"
)

col_useur <- "#110a9a"
col_cha <- "#e41c23"
col_ind <- "#ff7f00"
col_ssa <- "#06723e"

df_plot_production <- df_production_regions %>%
  pivot_wider(names_from = Region, values_from = value) %>%
  mutate(USAEUR = USA + EUR + REF + NEU + JPN) %>%
  select(-OAS, -USA, -EUR, -REF, -NEU, -JPN, -CAZ, -LAM, -MEA) %>%
  pivot_longer(cols = c(CHA, USAEUR, SSA, IND)) %>%
  mutate(Region = recode(name, !!!region_labels)) %>% 
  mutate(alpha = ifelse(type == "bof", 0.7, ifelse(type == "eaf", 0.5,0.3))) %>%
  mutate(Region = factor(Region, levels = c("Sub-saharan Africa", "India","China", "USA, Europe, Russia,\nJapan and ex-USSR countries")))


p <- ggplot(data = df_plot_production,
            aes(x = Historic_Time, y = value, fill = Region, alpha = type, group = interaction(type, Region))) +
  geom_area() +
  scale_alpha_manual(values = c("bof" = 0.6, "eaf" = 0.4, "other" = 0.2), 
                    labels = c("Oxygen furnace", "Coal-DRI-EAF/IF\n(India only))", "Open hearth furnace/\nBessemer process")) +
  scale_fill_manual(values = c(
      "China" = col_cha,
      "Sub-saharan Africa" = col_ssa,
      "India" = col_ind,
      "USA, Europe, Russia,\nJapan and ex-USSR countries" = col_useur
    )) +
  theme_bw() +
  labs(title = "Historical primary steel production for key regions (by production type)",
       x = "Year",
       y = "Primary steel production (Mt/yr)",
       colour = "Region",
       alpha = "Steel production route") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 11),
    # legend.position = "bottom",
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
  )
  
p <- p +  
  #add segment and annotation
  #US/EUR
  geom_segment(aes(
    x = 1950, xend = 1965, y = 250, yend = 250), 
    arrow = arrow(length = unit(0.2, "cm")), 
    color = col_useur, show.legend = FALSE) +
  annotate("rect", 
          xmin= 1904, xmax=1950,
          ymin=200, ymax=370,
          alpha=0.4, color = col_useur, fill = "white") +
  annotate("text", x = 1940,
      y = 250, 
      #  label = str_wrap("1st wave: Global North, post WW2", width = 25),
      label ="1st wave:\nGlobal North,\npost WW2",
        hjust = 0.8, vjust = 0.1,
        lineheight = 0.9, size = 3.5) +
  #CHA
  geom_segment(aes(
    x = 1995, xend = 2010, y = 670, yend = 670), 
    arrow = arrow(length = unit(0.2, "cm")), 
    color = col_cha, show.legend = FALSE) +
  annotate("rect", 
          xmin= 1958, xmax=1995,
          ymin=600, ymax=740,
          alpha=0.4, color = col_cha, fill = "white") +
  annotate("text", x = 1990,
      y = 600, 
      #  label = str_wrap("1st wave: Global North, post WW2", width = 25),
      label ="2nd wave:\nChina, 2000s",
        hjust = 0.9, vjust = -0.3,
        lineheight = 0.9, size = 3.5) +
  #IND
  geom_segment(aes(
    x = 2005, xend = 2015, y = 1100, yend = 1100), 
    arrow = arrow(length = unit(0.2, "cm")), 
    color = col_ind, show.legend = FALSE) +
  annotate("rect", 
          xmin= 1971, xmax=2005,
          ymin=1050, ymax=1190,
          alpha=0.4, color = col_ind, fill = "white") +
  annotate("text", x = 2000,
      y = 1080, 
      #  label = str_wrap("1st wave: Global North, post WW2", width = 25),
      label ="3rd wave:\nIndia, today",
        hjust = 0.9, vjust = -0.2,
        lineheight = 0.9, size = 3.5) +
  #SSA
  geom_segment(aes(
    x = 2007, xend = 2019, y = 1300, yend = 1300), 
    arrow = arrow(length = unit(0.2, "cm")), 
    color = col_ssa, show.legend = FALSE) +
  annotate("rect", 
          xmin= 1962, xmax=2007,
          ymin=1240, ymax=1380,
          alpha=0.4, color = col_ssa, fill = "white") +
  annotate("text", x = 2002,
      y = 1270, 
      #  label = str_wrap("1st wave: Global North, post WW2", width = 25),
      label ="4th wave:\nSSA, near future",
        hjust = 0.9, vjust = -0.1,
        lineheight = 0.9, size = 3.5) +
  geom_vline(xintercept = 2022, linetype = "solid", size = 0.4 , color = "#565555")



p
ggsave("figs_temp/BOF_regional_production_plot_wprojections.png", p, width = 8, height = 6, dpi = 300)
```
