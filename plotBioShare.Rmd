```{R setup, include = FALSE}
path <- "C:/Users/claraba/Documents/PhD_work/Papers/SteelREMIND/Analysis/"
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(
    root.dir = path
    )


library(ggplot2)
library(gdx)
require(dplyr)
options(dplyr.summarise.inform = FALSE)
library(tidyr)
library(quitte)
library(lusweave)
library(ggsci)
library(pals)
library(stringr)
```

```{R, calc biofrac}


calc_biofrac <- function(gdx) {
    #calculate shares of bio/fossil solids in fe solids
    df.demFe <- as.quitte(readGDX(gdx, "vm_demFeSector_afterTax", field = "l", restore_zeros = F)[,,]) %>%
        # dimensions: vm_demFeSector_afterTax(ttot,regi,entySE,entyFE,"indst",emiMkt)
        filter(all_enty1 == "fesos", emi_sectors == "indst", all_emiMkt == "ETS", value > 0.) %>%
        select(period, region, all_enty, all_enty1, value) %>%
        rename(demFE = value, entySE = all_enty, entyFE = all_enty1) 
    df.demFETotal = df.demFe  %>% 
        group_by( region, period, entyFE) %>% 
        summarize(demFETotal = sum(demFE)) %>%
        ungroup
    df.SEShares = df.demFe  %>%
        left_join(df.demFETotal, by=c("region", "period", "entyFE")) %>%
        mutate(SEShare = demFE / demFETotal) %>%
        select(-demFE, -demFETotal)

    #get SE price
    df.SEprice <- as.quitte(readGDX(gdx, "pm_SEPrice", restore_zeros = F)) %>%
        select(region, period, all_enty, value) %>%
        rename(priceSE = value, entySE = all_enty)

    #calculate fraction and prices
    df.biosolidsfrac <- df.SEShares %>%
        filter(entyFE == "fesos")  %>% 
        filter(period > 2025, period < 2075) %>%
        left_join(df.SEprice, by=c("region", "period", "entySE"))

}
```

```{R, load gdx}

fasttrans <- "inputdata/gdx/FastTransition-PkBudg820.gdx"
lockin <- "inputdata/gdx/TransitionwLockIn-PkBudg820.gdx"
npi <- "inputdata/gdx/TransitionwLockIn-NPi.gdx"

# fasttrans_lowbio <- "inputdata/gdx/FastTransition_lowBio-PkBudg820.gdx"
# lockin_lowbio <- "inputdata/gdx/TransitionwLockIn_lowBio-PkBudg820.gdx"

# fasttrans_lowbio <- 
# lockin_lowbio <-
```

```{R, read gdx}	


fasttrans_biofrac <- calc_biofrac(fasttrans)
lockin_biofrac <- calc_biofrac(lockin)
npi_biofrac <- calc_biofrac(npi)

full_df <- bind_rows(
    fasttrans_biofrac %>% mutate(scenario = "FastTrans", bio = "standard"),
    lockin_biofrac %>% mutate(scenario = "LockIn", bio = "standard"),
    npi_biofrac %>% mutate(scenario = "NPI", bio = "standard")) %>% 
    mutate(bioShare = ifelse(entySE == "sesobio", SEShare, 1 - SEShare))


```


```{R, plot biofrac}
ggplot(full_df, aes(x = period, y = bioShare, color = scenario)) +
    geom_line() +
    facet_wrap(~region) +
    scale_color_manual(
        values = c("FastTrans" = "#1cca25", "LockIn" = "#00fff2", "NPI" = "#4c4f4c"),
        labels = c("FastTrans" = "Fast Transition", "LockIn" = "Lock-In", "NPI" = "NPi")
    ) +
    labs(
        title = "Share of bio solids in fossil solids",
        x = "Year",
        y = "Share of bio solids in FE solids",
        color = "Scenario"
    ) +
    theme_bw()
```

```{R, plot bio price}

df_plot <- full_df %>%
    filter(entySE == "sesobio") %>%
    select(region, period, scenario, priceSE)

ggplot(df_plot, aes(x = period, y = priceSE, color = scenario)) +
    geom_line() +
    facet_wrap(~region) +
    scale_color_manual(
        values = c("FastTrans" = "#1cca25", "LockIn" = "#00fff2", "NPI" = "#4c4f4c"),
        labels = c("FastTrans" = "Fast Transition", "LockIn" = "Lock-In", "NPI" = "NPi")
    ) +
    labs(
        title = "Bio solids price",
        x = "Year",
        y = "trUSD/TWa (?)",
        color = "Scenario"
    ) +
    theme_bw()

```

```{R, read gdx}	


fasttrans_biofrac <- calc_biofrac(fasttrans)
lockin_biofrac <- calc_biofrac(lockin)

fasttrans_biofrac_lowbio <- calc_biofrac(fasttrans_lowbio)
lockin_biofrac_lowbio <- calc_biofrac(lockin_lowbio)

full_df <- bind_rows(
    fasttrans_biofrac %>% mutate(scenario = "FastTrans", bio = "standard"),
    lockin_biofrac %>% mutate(scenario = "LockIn", bio = "standard"),
    fasttrans_biofrac_lowbio %>% mutate(scenario = "FastTrans_lowbio", bio = "low"),
    lockin_biofrac_lowbio %>% mutate(scenario = "LockIn_lowbio", bio = "low")) %>%
    mutate(bioShare = ifelse(entySE == "sesobio", SEShare, 1 - SEShare))


```


```{R, plot biofrac}
ggplot(full_df, aes(x = period, y = bioShare, color = scenario)) +
    geom_line() +
    facet_wrap(~region) +
    # scale_color_manual(
    #     values = c("FastTrans" = "#1cca25", "LockIn" = "#00fff2", "NPI" = "#4c4f4c"),
    #     labels = c("FastTrans" = "Fast Transition", "LockIn" = "Lock-In", "NPI" = "NPi")
    # ) +
    labs(
        title = "Share of bio solids in fossil solids",
        x = "Year",
        y = "Share of bio solids in FE solids",
        color = "Scenario"
    ) +
    theme_bw()
```

```{R, plot bio price}

df_plot <- full_df %>%
    filter(entySE == "sesobio") %>%
    select(region, period, scenario, priceSE)

ggplot(df_plot, aes(x = period, y = priceSE, color = scenario)) +
    geom_line() +
    facet_wrap(~region) +
    # scale_color_manual(
    #     values = c("FastTrans" = "#1cca25", "LockIn" = "#00fff2", "NPI" = "#4c4f4c"),
    #     labels = c("FastTrans" = "Fast Transition", "LockIn" = "Lock-In", "NPI" = "NPi")
    # ) +
    labs(
        title = "Bio solids price",
        x = "Year",
        y = "trUSD/TWa (?)",
        color = "Scenario"
    ) +
    theme_bw()
```

```{R, plot bio price}

df_plot <- full_df %>%
    filter(entySE == "sesofos") %>%
    select(region, period, scenario, priceSE)

ggplot(df_plot, aes(x = period, y = priceSE, color = scenario)) +
    geom_line() +
    facet_wrap(~region) +
    # scale_color_manual(
    #     values = c("FastTrans" = "#1cca25", "LockIn" = "#00fff2", "NPI" = "#4c4f4c"),
    #     labels = c("FastTrans" = "Fast Transition", "LockIn" = "Lock-In", "NPI" = "NPi")
    # ) +
    labs(
        title = "Fossil solids price",
        x = "Year",
        y = "trUSD/TWa (?)",
        color = "Scenario"
    ) +
    theme_bw()
```