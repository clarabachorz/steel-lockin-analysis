```{R setup, include = FALSE}
path <- "C:/Users/claraba/Documents/PhD_work/Papers/SteelREMIND/AnalysisScript/"
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(
    root.dir = path
    )

require(ggplot2)
require(tidyverse)
require(mrremind)
require(magclass)
require("quitte")

library("quitte")
library(dplyr)
library(gridExtra)
library(grid)
library(purrr)
```

```{R load data}
mifdata1 <- read.quitte("inputdata/mif/REMIND_generic_GreenPolicy-NPi.mif")

mifdata2 <- read.quitte("inputdata/mif/REMIND_generic_GreenPolicy_noReliningForSomeRegions-PkBudg820.mif")

mifdata3 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended-PkBudg820.mif")


mifdata4 <- read.quitte("inputdata/mif/REMIND_generic_GreenPolicy-PkBudg820.mif")
# mifdata3 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended_expensiveH2-2-PkBudg650.mif")

# mifdata4 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended_moreCCS-PkBudg650.mif")
# mifdata5 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended_moreBFCCS-PkBudg650.mif")
# mifdata6 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended_moreCCS_BFCCSEarlyReti-PkBudg650.mif")

# #other lock in scenarios
# mifdata7 <- read.quitte("inputdata/mif/REMIND_generic_GreenPolicyEarlyReti-PkBudg650.mif")
# mifdata8 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended-PkBudg1000.mif")
# mifdata9 <- read.quitte("inputdata/mif/REMIND_generic_GreenPolicyEarlyReti-PkBudg1000.mif")


# # #"default" scen. NPi?
# mifdata11 <- read.quitte("inputdata/mif/REMIND_generic_GreenPolicy-NPi.mif") %>%
#   mutate(scenario= "default") %>%
#   filter(variable == "Production|Industry|Steel|Primary") %>% #use primary production only
#   filter(between(period, 2020, 2100)) %>% 
#   arrange(region,period)

# write.csv(mifdata11, "primary_steel_prod_default.csv")

mifdata1 <- mifdata1 %>%
  mutate(scenario = "NPi")
  # mutate(scenario = "Policy Extended Transition")

mifdata2 <- mifdata2 %>%
  mutate(scenario = "Fast transition")

mifdata3 <- mifdata3 %>%
  mutate(scenario = "Extended lock-in")

mifdata4 <- mifdata4 %>%
  mutate(scenario = "Green Policy")

# mifdata5 <- mifdata5 %>%
#   mutate(scenario = "Early retirement of BF-BOF-CCS")

# mifdata6 <- mifdata6 %>%
#   mutate(scenario = "More CCS injection capacity +\nearly retirement of BF-BOF-CCS")

# mifdata7 <- mifdata7 %>%
#   mutate(scenario = "Green Policy (1.5C)")

# mifdata8 <- mifdata8 %>%
#   mutate(scenario = "Base scenario (WB2C)")

# mifdata9 <- mifdata9 %>%
#   mutate(scenario = "Green Policy (WB2C)")

# mifdata10 <- mifdata1 %>%
#   mutate(scenario = "Base scenario (1.5C)")


```

```{R plot params, echo = FALSE}	

fs = 10 # font size

steel_route <- tribble(
  ~route,          ~route_name, ~color,
  "DRI-NG-EAF-CCS", "DRI-EAF NG CCS",    "#8fd1af",
  "DRI-NG-EAF",     "DRI-EAF NG",    "#06b429",
  "DRI-H2-EAF",     "DRI-EAF H2",    "#17cff0",
    "BF-BOF-CCS",     "BF-BOF CCS",    "#a0a0a0",
  "BF-BOF",         "BF-BOF",    "#080808",
  "SCRAP-EAF",        "Scrap EAF",   "#fbd30d",
)
```

```{R change data, echo = FALSE}

base_list <- list(mifdata1, mifdata2, mifdata3)
india_list <- list(mifdata3, mifdata4)
test_list <- list(mifdata2, mifdata4)

# h2_list <- list(mifdata1, mifdata2)
# ccs_list <- list(mifdata1, mifdata4, mifdata5, mifdata6)

# lockin_list <- list(mifdata10, mifdata7, mifdata8, mifdata9)

#filter breakdown of steel production
process_data <- function(df) {
  df %>%
    filter(grepl("Production|Industry|Steel|+", variable, ignore.case = TRUE, fixed = TRUE)) %>%
    filter(region == "World", unit == "Mt/yr") %>%
    filter(between(period, 2020, 2100)) %>%
    mutate(variable = gsub("Production|Industry|Steel|+", "", variable)) %>%
    mutate(variable = sub("^\\|\\|\\|\\+\\|", "", variable, fixed = FALSE)) %>%
    filter(variable != "SCRAP-EAF") #remove secondary steel
}

process_data_ccs <- function(df) {
  df %>%
    filter(grepl("Production|Industry|Steel|+", variable, ignore.case = TRUE, fixed = TRUE)) %>%
    filter(between(period, 2020, 2100)) %>%
    mutate(variable = gsub("Production|Industry|Steel|+", "", variable)) %>%
    mutate(variable = sub("^\\|\\|\\|\\+\\|", "", variable, fixed = FALSE)) %>%
    filter(variable != "SCRAP-EAF") #remove secondary steel
}

process_data_lockin <- function(df) {
  df %>%
    filter(grepl("Production|Industry|Steel|+", variable, ignore.case = TRUE, fixed = TRUE)) %>%
    filter(region == "World", unit == "Mt/yr") %>%
    filter(between(period, 2020, 2100)) %>%
    mutate(variable = gsub("Production|Industry|Steel|+", "", variable)) %>%
    mutate(variable = sub("^\\|\\|\\|\\+\\|", "", variable, fixed = FALSE)) %>%
    filter(variable != "SCRAP-EAF") #remove secondary steel
}

# #get full df
# prsteel_df <- h2_list %>%
#   map_dfr(process_data)

# mainscens_df <- base_list %>%
#   map_dfr(process_data)

# ccsscen_df <- ccs_list %>%
#   map_dfr(process_data_ccs)

# lockin_df <- lockin_list %>%
#   map_dfr(process_data_lockin)

# #calculate h2 shareh2_ in total primary steel
# h2_share <- prsteel_df %>%
#   group_by(period, scenario) %>%
#   summarise(h2_share = sum(value[variable %in% c("DRI-H2-EAF", "DRI-NG-EAF")]) / sum(value)) %>%
#   mutate(h2_share = h2_share*100) #to percent

# h2_all_steel_shares <- prsteel_df %>%
#   group_by(period, scenario) %>%
#   summarise(
#     h2_share = sum(value[variable == "DRI-H2-EAF"]) / sum(value),
#     scrap_eaf_share = sum(value[variable == "SCRAP-EAF"]) / sum(value),
#     coal_based_share = sum(value[variable %in% c("BF-BOF", "BF-BOF-CCS")]) / sum(value)
#   ) %>%
#   mutate(
#     h2_share = h2_share * 100,
#     scrap_eaf_share = scrap_eaf_share * 100,
#     coal_based_share = coal_based_share * 100
#   )


# h2_share_lockin <- lockin_df %>%
#   group_by(period, scenario) %>%
#   summarise(h2_share = sum(value[variable == "DRI-H2-EAF"]) / sum(value)) %>%
#   mutate(h2_share = h2_share*100) #to percent

# #calculate amount of H2 dri
# h2_dri <- prsteel_df %>%
#   filter(variable == "DRI-H2-EAF") %>%
#   group_by(period, scenario) %>%
#   summarise(value = sum(value))

# ccs_share <- ccsscen_df %>%
#   group_by(period, scenario, region) %>%
#   summarise(ccs_share = sum(value[variable == "BF-BOF-CCS"]) / sum(value)) %>%
#   mutate(ccs_share = ccs_share*100) #to percent

# all_steel_shares <- ccsscen_df %>%
#   group_by(period, scenario, region) %>%
#   summarise(
#     total_production = sum(value, na.rm = TRUE),
#     h2_share = sum(value[variable == "DRI-H2-EAF"], na.rm = TRUE) / total_production,
#     bf_bof_ccs_share = sum(value[variable == "BF-BOF-CCS"], na.rm = TRUE) / total_production,
#     bf_bof_share = sum(value[variable == "BF-BOF"], na.rm = TRUE) / total_production,
#     ng_share = sum(value[variable == "DRI-NG-EAF"], na.rm = TRUE) / total_production
#   )


```

```{R plot global barplots}

target_labels <- list(
  "1.5C" = "Steel sector transition for a 1.5°C target (with overshoot)",
  "WB2C" = "Steel sector transition for a well below 2°C target"
)

target_labeller = function(variable, value) {
  return(target_labels[value])
}

route_colors <- setNames(steel_route$color, steel_route$route)

mainscens_df_plot <- mainscens_df %>%
  filter(period %in% c(2020,2025, 2030, 2035, 2040, 2045, 2050, 2055,2060)) %>%
  # filter(grepl("1.5C", scenario, ignore.case = TRUE, fixed = TRUE)) %>%
  mutate(
    target = str_extract(scenario, "1\\.5C|WB2C"),
    scenario_clean = gsub("\\(1\\.5C\\)|\\(WB2C\\)", "", scenario),
    period_scenario = paste(period, scenario_clean)
    ) %>%
  arrange(period, scenario) %>%
  mutate(
  period_scenario = factor(period_scenario, levels = unique(period_scenario)),
  target = factor(target, levels = c("1.5C", "WB2C"))
  )


scenario_x_offsets <- mainscens_df_plot %>%
  distinct(scenario_clean) %>%
  arrange(scenario_clean) %>%
  mutate(offset = seq(-0.8,0.8,length.out = n()))

mainscens_df_plot <- mainscens_df_plot %>%
  left_join(scenario_x_offsets, by = "scenario_clean") %>%
  mutate(xpos = as.numeric(period) + offset)

# custom x labels
xlabels_df <- mainscens_df_plot %>%
  distinct(xpos, scenario_clean)

#dates
dates_df <- mainscens_df_plot %>%
  filter(target == "WB2C") %>%
  group_by(period,target) %>%
  summarise(x= mean(xpos)) %>%
  mutate(
    grob = lapply(period, function(lbl){
      textGrob(lbl, gp = gpar(fontsize = fs+2, fontface = "bold"))
    }),
    xmin = x - 1.9,
    xmax = x + 0.5,
    ymin = -960,
    ymax = -960,
  )

# ggplot(mainscens_df_plot, aes(x=period_scenario, y = value, fill = variable)) +
p <- ggplot(mainscens_df_plot, aes(x = xpos, y = value, fill = variable)) +
  geom_bar(
    stat = "identity",
    ) +
  scale_fill_manual(values = route_colors) +
  facet_wrap(~target, ncol = 1, labeller = target_labeller) +
  scale_x_continuous(
    breaks = xlabels_df$xpos,
    labels = xlabels_df$scenario_clean,
    expand = c(0, 0)
  ) +
  labs(
    x = "Scenario and period",
    y = "Steel production (Mt/yr)",
    fill = "Production route") +
  theme_bw(base_size = fs+5) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    plot.margin = margin(10, 10, 30, 10),
    axis.title.x = element_text(margin = margin(t = 25)),
    strip.text = element_text(size = fs+3, face = "bold"),
  ) +
  coord_cartesian(clip = "off")

for (i in seq_len(nrow(dates_df))) {
  p <- p + annotation_custom(
    dates_df$grob[[i]],
    xmin = dates_df$xmin[i],
    xmax = dates_df$xmax[i],
    ymin = dates_df$ymin[i],
    ymax = dates_df$ymax[i]
  )
}
p
ggsave("figs_temp/steel_production_scenarios.png", width = 12, height = 10, dpi = 300)
```

```{R calc cumu em}
calc_cumuem <- function(df, region_to_calculate) {
  df %>%
    filter(grepl("Emi|CO2|Energy|Demand|Industry|Steel|+",
                # "Emi|CO2|Energy|Demand|Industry|Steel", # if we want the breakdown of what kind of liquids etc
                 variable,
                 ignore.case = TRUE, 
                 fixed = TRUE)) %>%
    # filter(between(period, 2025, 2070),
    filter(between(period, 2025, 2070),
           region == region_to_calculate) %>%
    select(-model, -region) %>%
    #add up the different components: solid, liquids ..
    group_by(period, scenario) %>%
    summarise(total_CO2_yearly = sum(value, na.rm = TRUE),
          total_CO2_5year = total_CO2_yearly * 5) %>%
    ungroup() %>%
    group_by(scenario) %>%
    mutate(cumu_CO2 = cumsum(total_CO2_5year)) %>%
    summarise(cumu_CO2 = max(cumu_CO2))
}


calc_em <- function(df) {
  df %>%
    filter(grepl("Emi|CO2|Energy|Demand|Industry|Steel|+",
                # "Emi|CO2|Energy|Demand|Industry|Steel", # if we want the breakdown of what kind of liquids etc
                 variable,
                 ignore.case = TRUE, 
                 fixed = TRUE)) %>%
    # filter(between(period, 2025, 2070),
    filter(between(period, 2025, 2070)) %>%
    select(-model) %>%
    #add up the different components: solid, liquids ..
    group_by(period, scenario, region) %>%
    summarise(total_CO2_yearly = sum(value, na.rm = TRUE),
          total_CO2_5year = total_CO2_yearly * 5)
}

# ccsscen_emi_df <- ccs_list %>%
#   map_dfr(calc_cumuem) 

mainscens_df_emi <- base_list %>%
  map_dfr(calc_cumuem, region_to_calculate = "World")

mainscens_df_emi_notcumu <- base_list %>%
  map_dfr(calc_em)

indiascens_df_emi <- india_list %>%
  map_dfr(calc_cumuem, region_to_calculate = "IND")

indiascens_df_emi_notcumu <- india_list %>%
  map_dfr(calc_em)

testscens_df_eminotcumu <- test_list %>%
  map_dfr(calc_em)

```


```{R plot h2 share, echo = FALSE}

h2_share_plot <- h2_share

#factors for scenarios
# h2_share_plot$scenario <- factor(h2_share_plot$scenario, levels = c("Base H2 cost", "High H2 cost", "Very high H2 cost"))


#make line plot of h2 share, one line for each scenario

ggplot(h2_share_plot, aes(x = period, y = h2_share, color = scenario)) +
  geom_line(size = 0.6, alpha = 0.8) +
  geom_point(size = 2, shape = 21, fill = "white", stroke = 0.8) +
  labs(title = "Share of DRI-H2-EAF in total steel production",
       x = "Time",
       y = "DRI-H2-EAF share (%)",
       color = "Scenario") +
  # scale_color_viridis_d(option = "C") +
  scale_color_manual(values = c("#0d55c9", "#22cdbc", "#8586bc", "#3d3d3f","#8d8d92", "#41415d")) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.title = element_text(face = "bold")
  ) +
  guides(color = guide_legend(nrow = 2, byrow = TRUE))

#save
# ggsave("figs/h2_share.png", width = 8, height = 5, dpi = 300)
```

```{R plot h2 scen all steel shares, echo = FALSE}

h2_all_steel_shares_long <- h2_all_steel_shares %>%
  pivot_longer(
    cols = c("h2_share", "scrap_eaf_share", "coal_based_share"),
    names_to = "steel_type",
    values_to = "share"
  )

h2_all_steel_shares_long <- h2_all_steel_shares_long %>%
  mutate(steel_type = recode(steel_type,
                             h2_share = "Hydrogen-based steel\n(DRI-H2-EAF)",
                             scrap_eaf_share = "Secondary steel\n(Scrap EAF)",
                             coal_based_share = "Coal-based steel production\n(BF-BOF-CCS + BF-BOF)"))

ggplot(h2_all_steel_shares_long, aes(x = period, y = share, color = scenario)) +
  geom_line(size = 0.6, alpha = 0.8) +
  geom_point(size = 2, shape = 21, fill = "white", stroke = 0.8) +
  labs(
    title = "Steel production shares by production route",
    x = "Time",
    y = "Share (%)",
    color = "Scenario"
  ) +
  scale_color_manual(values = c("#0d55c9", "#22cdbc", "#8586bc", "#3d3d3f", "#8d8d92", "#41415d")) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.title = element_text(face = "bold")
  ) +
  guides(color = guide_legend(nrow = 1, byrow = TRUE)) +
  facet_wrap(~ steel_type)

#save
# ggsave("figs/h2scenarios_all_steel_shares.png", width = 8, height = 5, dpi = 300)
```
```{R plot h2 share lockin scen, echo = FALSE}

# h2_share_plot <- h2_share_lockin

#factors for scenarios
# h2_share_plot$scenario <- factor(h2_share_plot$scenario, levels = c("Base H2 cost", "High H2 cost", "Very high H2 cost"))


#make line plot of h2 share, one line for each scenario

ggplot(h2_share_lockin, aes(x = period, y = h2_share, color = scenario)) +
  geom_line(size = 0.6, alpha = 0.8) +
  geom_point(size = 2, shape = 21, fill = "white", stroke = 0.8) +
  labs(title = "Share of DRI-H2-EAF in primary steel production",
       x = "Time",
       y = "DRI-H2-EAF share (%)",
       color = "Scenario") +
  # scale_color_viridis_d(option = "C") +
  # scale_color_manual(values = c("#d7a614", "#bb5700", "#3fa60e", "#1a7213")) +
  scale_color_manual(values = c("#88CCEE", "#FDB863", "#0072B2", "#D55E00")) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.title = element_text(face = "bold")
  ) +
  guides(color = guide_legend(nrow = 2, byrow = TRUE))

#save
ggsave("figs_temp/h2_share_lockin.png", width = 8, height = 5, dpi = 300)
```


```{R plot ccs cumu emi}
# Copy the data
ccsscen_emi_df_plot <- ccsscen_emi_df

# Rename "Base H2 cost" to "Base CCS assumption"
ccsscen_emi_df_plot$scenario <- gsub("Base H2 cost", "Base CCS assumption", ccsscen_emi_df_plot$scenario)

# Get unique scenario names
unique_scenarios <- unique(ccsscen_emi_df_plot$scenario)

# Convert to factor
ccsscen_emi_df_plot$scenario <- factor(ccsscen_emi_df_plot$scenario, levels = unique_scenarios)

# Define colors
custom_colors <- c(
  "Base CCS assumption" = "#8A704E",
  "More CCS injection capacity" = "#b09105",
  "Early retirement of BF-BOF-CCS" = "#bf6e12",
  "More CCS injection capacity +\nearly retirement of BF-BOF-CCS" = "#e6c90e"
)

# Compute percentage difference
base_value <- ccsscen_emi_df_plot %>%
  filter(scenario == "Base CCS assumption") %>%
  pull(cumu_CO2) / 1e3  # Convert to same units

ccsscen_emi_df_plot <- ccsscen_emi_df_plot %>%
  mutate(percentage_diff = ifelse(scenario == "Base CCS assumption", 
                                  NA, 
                                  ((cumu_CO2 / 1e3 - base_value) / base_value) * 100))

# Find x-coordinates of bars
x_base <- which(levels(ccsscen_emi_df_plot$scenario) == "Base CCS assumption")
x_others <- which(levels(ccsscen_emi_df_plot$scenario) != "Base CCS assumption")

# Find y-coordinates for arrows
y_base <- base_value + 30  # Slightly above base bar
y_others <- ccsscen_emi_df_plot$cumu_CO2[ccsscen_emi_df_plot$scenario != "Base CCS assumption"] / 1e3 + 30

# Plot
ggplot(ccsscen_emi_df_plot, aes(x = scenario, y = cumu_CO2 / 1e3, fill = scenario)) +
  geom_bar(stat = "identity", width = 0.6) +
  scale_fill_manual(values = custom_colors) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 20)) +
  labs(
    title = "Cumulative CO2 Emissions (2025-2070)\nfrom steel production, by scenario",
    x = "Scenario",
    y = "Cumulative CO2 (Gt CO2)"
  ) +
  theme_classic() +
  guides(fill = "none") +
  scale_y_continuous(
    name = "Cumulative CO2 (Gt CO2)",
    sec.axis = sec_axis(~ ((. / 235)) * 100, name = "Fraction of remaining 1.5°C carbon budget (%)")
  ) +
  theme(
    text = element_text(size = 10),
    title = element_text(size = 12),
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.grid.major = element_line(linetype = "dashed", color = "gray70")
  ) +
  # Add arrows from Base CCS assumption to other bars
  geom_segment(aes(x = x_base, xend = x_base, y = base_value, yend = y_base), 
               color = "#7e7e7e") +
  geom_segment(aes(x = x_base, xend = x_others[3], y = y_base, yend = y_base), 
               color = "#7e7e7e") +
  geom_segment(aes(x = x_others[1], xend = x_others[1], y = y_base, yend = y_others[1]-30),
               arrow = arrow(type = "closed", length = unit(0.15, "inches")), color = "#7e7e7e") +
  geom_segment(aes(x = x_others[2], xend = x_others[2], y = y_base, yend = y_others[2]-30),
               arrow = arrow(type = "closed", length = unit(0.15, "inches")), color = "#7e7e7e") +
  geom_segment(aes(x = x_others[3], xend = x_others[3], y = y_base, yend = y_others[3]-30),
               arrow = arrow(type = "closed", length = unit(0.15, "inches")), color = "#7e7e7e") +

  # Add white circles behind percentage difference labels
  geom_point(aes(x = x_base*2, y = (y_base) / 2 + 35),
             shape = 21, fill = "white", color = "#7e7e7e", size = 15) +
  geom_point(aes(x = x_base*3, y = (y_base) / 2 + 35),
             shape = 21, fill = "white", color = "#7e7e7e", size = 15) +
  geom_point(aes(x = x_base*4, y = (y_base) / 2 + 30),
             shape = 21, fill = "white", color = "#7e7e7e", size = 15) +
  # Add percentage difference labels above arrows
  annotate("text", x = (x_base*2), y = (y_base) / 2 + 35,
           label = paste0(round(ccsscen_emi_df_plot$percentage_diff[2], 1), "%"), size = 3, fontface = "bold", color = "#7e7e7e") +
  annotate("text", x = (x_base *3), y = y_base/ 2 + 35,
           label = paste0(round(ccsscen_emi_df_plot$percentage_diff[3], 1), "%"), size = 3, fontface = "bold", color = "#7e7e7e") +
  annotate("text", x = (x_base *4), y = (y_base ) / 2 +30,
           label = paste0(round(ccsscen_emi_df_plot$percentage_diff[4], 1), "%"), size = 3, fontface = "bold", color = "#7e7e7e")

#save
# ggsave("figs/cumu_emi_ccs_scen.png", width = 8, height = 5, dpi = 300)

```

```{R plot base cumu emi}
# Copy the data
mainscens_emi_df_plot <- mainscens_df_emi %>%
  mutate(cumu_CO2 = cumu_CO2 / 1e3)  # Convert to Gt CO2

# Get unique scenario names
unique_scenarios <- c(unique(mainscens_emi_df_plot$scenario))
co2_emissions <- c(mainscens_emi_df_plot$cumu_CO2)

# Convert to factor
mainscens_emi_df_plot$scenario <- factor(mainscens_emi_df_plot$scenario, levels = unique_scenarios)


# # find x-coordinates of bars
x_base <- which(levels(mainscens_emi_df_plot$scenario) == unique_scenarios[1])
x_others <- which(levels(mainscens_emi_df_plot$scenario) != unique_scenarios[1])


y1 <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == unique_scenarios[1]]
y2 <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == unique_scenarios[2]]
y3 <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == unique_scenarios[3]]
# y2 <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == "Base scenario (WB2C)"] / 1e3


# emi_1p5diff <- y1- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == "Green Policy (1.5C)"] / 1e3
# emi_wb2cdiff <- y2-mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == "Green Policy (WB2C)"] / 1e3

# # find y-coordinates for arrows
y_base <- y1 + 5  # slightly above base bar
# y_others <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario != "Base scenario (1.5C)"] / 1e3 + 30



# Plot
ggplot(mainscens_emi_df_plot, aes(x = scenario, y = cumu_CO2, fill = scenario)) +
  geom_bar(stat = "identity", width = 0.6) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 20)) +
  # scale_fill_manual(values = c("#d7a614", "#3fa60e", "#bb5700", "#1a7213")) +
  scale_fill_manual(values = c("#88CCEE", "#FDB863", "#D55E00")) +
  labs(
    title = "Cumulative CO2 Emissions (2025-2070)\nfrom steel production, by scenario",
    x = "Scenario",
    y = "Cumulative CO2 (Gt CO2)"
  ) +
  theme_classic(base_size = fs+3) +
  guides(fill = "none") +
  scale_y_continuous(
    name = "Cumulative CO2 (Gt CO2)",
    sec.axis = sec_axis(~ ((. / 585)) * 100, name = "Fraction of remaining well-below 2°C carbon budget (%)")
  ) +
  theme(
    text = element_text(size = 9),
    title = element_text(size = 11),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 9),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.grid.major = element_line(linetype = "dashed", color = "gray70")
  ) +
  annotate("text", x = (x_base*1), y = y_base,
            label = paste0("", round(co2_emissions[1], 0), " GtCO2"), size = 3, fontface = "bold", color = "#7e7e7e") +
  annotate("text", x = (x_base*2), y = y2 +5,
            label = paste0("", round(co2_emissions[2], 0), " GtCO2"), size = 3, fontface = "bold", color = "#7e7e7e") +
  annotate("text", x = (x_base*3), y = y3 +5,
           label = paste0("", round(co2_emissions[3], 0), " GtCO2"), size = 3, fontface = "bold", color = "#7e7e7e")
  #+
  # # Add arrows from Base CCS assumption to other bars
  # geom_segment(aes(x = x_base, xend = x_base, y = y1, yend = y_base), 
  #              color = "#7e7e7e") +
  # geom_segment(aes(x = x_base, xend = x_others[1], y = y_base, yend = y_base), 
  #              color = "#7e7e7e") +
  # geom_segment(aes(x = x_others[2], xend = x_others[2], y = y2, yend = y2+10), 
  #              color = "#7e7e7e") +
  # geom_segment(aes(x = x_others[2], xend = x_others[3], y = y2+10, yend = y2+10), 
  #              color = "#7e7e7e") +
  # geom_segment(aes(x = x_others[1], xend = x_others[1], y = y_base, yend = y_others[1]-30),
  #              arrow = arrow(type = "closed", length = unit(0.15, "inches")), color = "#7e7e7e") +
  # geom_segment(aes(x = x_others[3], xend = x_others[3], y = y2+10, yend = y_others[3]-30),
  #              arrow = arrow(type = "closed", length = unit(0.15, "inches")), color = "#7e7e7e") +

  # # Add white circles behind percentage difference labels
  # geom_point(aes(x = x_base*2, y = (y_base) / 2 + 15),
  #            shape = 21, fill = "white", color = "#7e7e7e", size = 20) +

  # geom_point(aes(x = x_base*4, y = (y_base) / 2 + 35),
  #            shape = 21, fill = "white", color = "#7e7e7e", size = 20) +
  
  # annotate("text", x = (x_base*2), y = (y_base) / 2 + 15,
  #          label = paste0("-", round(emi_1p5diff, 1), "\nGtCO2"), size = 3, fontface = "bold", color = "#7e7e7e") +
  # annotate("text", x = (x_base *4), y = (y_base ) / 2 +35,
  #          label = paste0("-", round(emi_wb2cdiff, 1), "\nGtCO2"), size = 3, fontface = "bold", color = "#7e7e7e")

#save
# ggsave("figs_temp/cumu_emi_base_scen.png", width = 5, height = 5, dpi = 300)

```

```{R plot base cumu emi}

scenario_order <- c("Green Policy", "Extended lock-in")

# Copy the data
mainscens_emi_df_plot <- indiascens_df_emi %>%
  mutate(cumu_CO2 = cumu_CO2 / 1e3)   # Convert to Gt CO2

# Get unique scenario names
unique_scenarios <- c(unique(mainscens_emi_df_plot$scenario))

# Convert to factor
mainscens_emi_df_plot$scenario <- factor(mainscens_emi_df_plot$scenario, levels = scenario_order)

#order columns the expected way and grab cumulative CO2 emissions
mainscens_emi_df_plot <-  mainscens_emi_df_plot[order(mainscens_emi_df_plot$scenario),]
co2_emissions <- c(mainscens_emi_df_plot$cumu_CO2)


# # find x-coordinates of bars
x_base <- which(levels(mainscens_emi_df_plot$scenario) == unique_scenarios[1])
x_others <- which(levels(mainscens_emi_df_plot$scenario) != unique_scenarios[1])


y1 <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == scenario_order[1]]
y2 <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == scenario_order[2]]
#
# # find y-coordinates for arrows
y_base <- y1 + 1  # slightly above base bar
# y_others <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario != "Base scenario (1.5C)"] / 1e3 + 30

fs <- 12	


# Plot
ggplot(mainscens_emi_df_plot, aes(x = scenario, y = cumu_CO2, fill = scenario)) +
  geom_bar(stat = "identity", width = 0.6) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 20)) +
  # scale_fill_manual(values = c("#d7a614", "#3fa60e", "#bb5700", "#1a7213")) +
  scale_fill_manual(values = c("#88CCEE", "#D55E00")) +
  labs(
    title = "Cumulative CO2 Emissions in India (2025-2070)\nfrom steel production, by scenario",
    x = "Scenario",
    y = "Cumulative CO2 (Gt CO2)"
  ) +
  theme_classic(base_size = fs+3) +
  guides(fill = "none") +
  scale_y_continuous(
    name = "Cumulative CO2 (Gt CO2)",
    sec.axis = sec_axis(~ ((. / 585)) * 100, name = "Fraction of remaining well-below 2°C carbon budget (%)")
  ) +
  theme(
    text = element_text(size = 9),
    title = element_text(size = 11),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 9),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.grid.major = element_line(linetype = "dashed", color = "gray70")
  ) +
  annotate("text", x = (x_base*0.5), y = y_base,
            label = paste0("", round(co2_emissions[1], 0), " GtCO2"), size = 3, fontface = "bold", color = "#7e7e7e") +
  annotate("text", x = (x_base*1), y = y2 +1,
            label = paste0("", round(co2_emissions[2], 0), " GtCO2"), size = 3, fontface = "bold", color = "#7e7e7e")
#save
# ggsave("figs_temp/cumu_emi_india_scen.png", width = 5, height = 5, dpi = 300)

```

```{R}

plot_emi_notcumu <- mainscens_df_emi_notcumu %>%
  filter(scenario != "NPi")

#plot annual emissions (Gt per year) for all regions
#facet is region
p <- ggplot(plot_emi_notcumu) +
  geom_line(aes(x = period, y = total_CO2_yearly, color = scenario), size = 0.6) + #to GtCO2
  geom_point(aes(x = period, y = total_CO2_yearly, color = scenario), size = 2, shape = 21, fill = "white", stroke = 0.8) +
  facet_wrap(~ region, scales = "free_y") +
  labs(title = "Annual CO2 Emissions from Steel Production (2025-2070) by Region and Scenario",
       x = "Year",
       y = "CO2 Emissions (Mt CO2)",
       color = "Scenario") +
  scale_color_manual(values = c("#4d4d50","#c9b60d")) +
  theme_minimal(base_size = 14)

p
```

```{R}

testscens_df_eminotcumu_plot <- mainscens_df_emi_notcumu %>%
  filter(region != "World") %>% #filter out world
  filter(scenario != "NPi") %>% #filter out NPi scenario
  group_by(region, scenario) %>%
  arrange(period) %>%
  mutate(cumuCO2 = cumsum(total_CO2_5year)) %>%
  ungroup()

#order by largest area
last_period <- max(testscens_df_eminotcumu_plot$period)

region_order <- testscens_df_eminotcumu_plot %>%
  filter(period == last_period) %>%
  group_by(region) %>%
  summarise(cumuCO2 = max(cumuCO2), .groups = "drop") %>%
  arrange(cumuCO2) %>%
  pull(region)
testscens_df_eminotcumu_plot$region <- factor(testscens_df_eminotcumu_plot$region, levels = region_order)

#calculate percentage of total CO2
totalCO2_2070 <- testscens_df_eminotcumu_plot %>%
  group_by(scenario) %>%
  filter(period == last_period) %>%
  summarise(totalCO2 = sum(cumuCO2)) %>%
  pull(totalCO2)
scale_factor <- 100/ (totalCO2_2070 / 1e3)

#plot area plot of cumulative emissions
ggplot(testscens_df_eminotcumu_plot, aes(x = period, y = cumuCO2 / 1e3, fill = region)) +
  geom_area( alpha = 0.8) +
  facet_wrap(~ scenario) +
  labs(title = "Cumulative CO2 Emissions from steel production (2025-2070)",
       x = "Year",
       y = "Cumulative CO2 Emissions (Gt CO2)",
       fill = "Region") +
  # scale_y_continuous(
  #   sec.axis = sec_axis(~ . * scale_factor, name = "Percentage of total CO2 emissions in 2070 (%)")
  # ) +
  scale_fill_manual(values = c("CHA" = "#e41818",
                            "IND"="#e48108",
                            "JPN"="#d4c7b1",
                            "OAS"="#c9b60d",
                            "USA"="#08a0e4",
                            "EUR"="#0912c3",
                            "NEU"="#c9b60d",
                            "REF"="#aac90d",
                            "SSA"="#0dc90d",
                            "LAM"="#c90dbc",
                            "MEA"="#8340c2",
                            "CAZ"="#08e4a0")
                            ) +
  theme_minimal(base_size = 14)
```

```{R}

plot_emi_notcumu <- indiascens_df_emi_notcumu %>%
  filter(region == "IND") %>%
  select(-region)

#plot annual emissions (Gt per year) for all regions
#facet is region
p <- ggplot(plot_emi_notcumu) +
  geom_line(aes(x = period, y = total_CO2_yearly, color = scenario), size = 0.6) + #to GtCO2
  geom_point(aes(x = period, y = total_CO2_yearly, color = scenario), size = 2, shape = 21, fill = "white", stroke = 0.8) +
  labs(title = "Annual CO2 Emissions from Steel Production in India (2025-2070) by scenario",
       x = "Year",
       y = "CO2 Emissions (Mt CO2)",
       color = "Scenario") +
  scale_color_manual(values = c(
    "Extended lock-in" = "#4d4d50",
    "Fast transition"="#c9b60d",
    "Green Policy"="#0dc962")) +
  theme_minimal(base_size = 14)

p
```

```{R plot ccs share, echo = FALSE}

ccs_share_glob <- ccs_share %>%
  filter(region == "World") %>%
  select(-region)

#rename "base H2 cost" to "Base H2 cost"
ccs_share_glob$scenario <- gsub("Base H2 cost", "Base CCS assumption", ccs_share_glob$scenario)

#factors for scenarios
ccs_share_glob$scenario <- factor(ccs_share_glob$scenario, levels = c("Base CCS assumption", "More CCS injection capacity","Early retirement of BF-BOF-CCS", "More CCS injection capacity +\nearly retirement of BF-BOF-CCS"))

#plot
ggplot(ccs_share_glob, aes(x = period, y = ccs_share, color = scenario)) +
  geom_line(size = 0.6, alpha = 1) +
  geom_point(size = 2, shape = 21, fill = "white", stroke = 0.8) +
  labs(title = "Share of BF-BOF-CCS in total primary steel production (World)",
       x = "Time",
       y = "BF-BOF-CCS share (%)",
       color = "Scenario") +
  scale_color_viridis_d(option = "inferno", end = 0.8, direction = -1) +
  #scale_color_manual(values = c("#c6c9cd", "#928166", "#8d5252", "#000000")) +
  #add y limit
  ylim(0, 100) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.title = element_text(face = "bold")
  )+
  guides(color = guide_legend(nrow = 2, byrow = TRUE))

#save
# ggsave("figs/ccs_share_global.png", width = 8, height = 5, dpi = 300)
```

```{R plot ccs share, echo = FALSE}

ccs_share_IND <- ccs_share %>%
  filter(region == "IND") %>%
  select(-region)

#rename "base H2 cost" to "Base H2 cost"
ccs_share_IND$scenario <- gsub("Base H2 cost", "Base CCS assumption", ccs_share_IND$scenario)

#factors for scenarios
ccs_share_IND$scenario <- factor(ccs_shar_INDe$scenario, levels = c("Base CCS assumption", "More CCS injection capacity","Early retirement of BF-BOF-CCS", "More CCS injection capacity +\nearly retirement of BF-BOF-CCS"))

#plot
ggplot(ccs_share_IND, aes(x = period, y = ccs_share, color = scenario)) +
  geom_line(size = 0.6, alpha = 1) +
  geom_point(size = 2, shape = 21, fill = "white", stroke = 0.8) +
  labs(title = "Share of BF-BOF-CCS in total primary steel production (India)",
       x = "Time",
       y = "BF-BOF-CCS share (%)",
       color = "Scenario") +
  scale_color_viridis_d(option = "inferno", end = 0.8) +
  #scale_color_manual(values = c("#c6c9cd", "#928166", "#8d5252", "#000000")) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.title = element_text(face = "bold")
  )+
  guides(color = guide_legend(nrow = 2, byrow = TRUE))

```

```{R plot ccs share, echo = FALSE}

ccs_share_CHA <- ccs_share %>%
  filter(region == "CHA") %>%
  select(-region)

#rename "base H2 cost" to "Base H2 cost"
ccs_share_CHA$scenario <- gsub("Base H2 cost", "Base CCS assumption", ccs_share_CHA$scenario)

#factors for scenarios
ccs_share_CHA$scenario <- factor(ccs_share_CHA$scenario, levels = c("Base CCS assumption", "More CCS injection capacity","Early retirement of BF-BOF-CCS", "More CCS injection capacity +\nearly retirement of BF-BOF-CCS"))

#plot
ggplot(ccs_share_CHA, aes(x = period, y = ccs_share, color = scenario)) +
  geom_line(size = 0.6, alpha = 1) +
  geom_point(size = 2, shape = 21, fill = "white", stroke = 0.8) +
  labs(title = "Share of BF-BOF-CCS in total primary steel production (China)",
       x = "Time",
       y = "BF-BOF-CCS share (%)",
       color = "Scenario") +
  scale_color_viridis_d(option = "inferno", end = 0.8, direction = -1) +
  #scale_color_manual(values = c("#c6c9cd", "#928166", "#8d5252", "#000000")) +
  # theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.title = element_text(face = "bold")
  )+
  guides(color = guide_legend(nrow = 2, byrow = TRUE))

#save
# ggsave("figs/ccs_share_oas.png", width = 8, height = 5, dpi = 300)
```

```{R plot ccs area plots, echo = FALSE}

plot_df <- all_steel_shares %>%
  filter(region == "World") %>%
  select(-total_production) %>%  # Remove unnecessary column
  pivot_longer(cols = ends_with("_share"), 
               names_to = "steel_route", 
               values_to = "share")  # Convert to long format for ggplot

plot_df$scenario <- gsub("Base H2 cost", "Base CCS assumption", plot_df$scenario)

# Improve steel_route labels
plot_df$steel_route <- recode(plot_df$steel_route,
                              "h2_share" = "DRI-H2-EAF",
                              "bf_bof_ccs_share" = "BF-BOF-CCS",
                              "bf_bof_share" = "BF-BOF",
                              "ng_share" = "DRI-NG-EAF")

plot_df <- plot_df %>%
  left_join(steel_route, by = c("steel_route" = "route"))

plot_df$steel_route <- factor(plot_df$steel_route, 
                              levels = c( "DRI-NG-EAF", "DRI-H2-EAF","BF-BOF-CCS","BF-BOF"))

color_mapping <- setNames(plot_df$color, plot_df$steel_route)

# COMBINED PLOT


# # Create a new column for the combined share of BF-BOF and BF-BOF CCS
plot_df <- plot_df %>%
  group_by(period, scenario) %>%
  mutate(combined_bf_bof_share = sum(share[steel_route %in% c("BF-BOF", "BF-BOF-CCS")])) %>%
  ungroup()


#COMBINE area plots
unique_scenarios <- unique(plot_df$scenario)

custom_linetypes <- c(
  "solid" = "solid",
  "dashed" = "44",
  "dotted" = "11",
  "dotdash" = "331331"
)

# Plot
ggplot() +
  geom_area(data = plot_df %>% filter(scenario == unique_scenarios[1]),
            aes(x = period, y = share, fill = steel_route), alpha = 0.25) +
  geom_area(data = plot_df %>% filter(scenario == unique_scenarios[2]),
            aes(x = period, y = share, fill = steel_route), alpha = 0.25) +
  geom_area(data = plot_df %>% filter(scenario == unique_scenarios[3]),
            aes(x = period, y = share, fill = steel_route), alpha = 0.25) +
  geom_area(data = plot_df %>% filter(scenario == unique_scenarios[4]),
            aes(x = period, y = share, fill = steel_route), alpha = 0.25) +
  scale_fill_manual(values = color_mapping) +
  labs(title = "Primary steel production share by pathway, for four CCS scenarios",
       x = "Year",
       y = "Share",
       fill = "Production pathway") +
  scale_y_continuous(labels = scales::percent_format(), expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  # Overlay lines showing combined BF-BOF + BF-BOF CCS share with scenario-dependent linetype
  # geom_line(data = plot_df,
  #           aes(x = period, y = combined_bf_bof_share, group = scenario, color = scenario, linetype = scenario),
  #           size = 1.2) +
  # # Overlay lines showing BF-BOF share with scenario-dependent linetype
  geom_line(data = plot_df %>% filter(steel_route == "BF-BOF"),
            aes(x = period, y = share, group = scenario, linetype = scenario), #used to have  color = scenario,
            color = "#eadede",
            size = 1.2) +
  #scale_color_manual(name = "Scenario", values = setNames(c("#010101", "#ff6200", "#cb0ece", "#ffffff"), unique_scenarios)) +
  # scale_linetype_manual(name = "Scenario", values = setNames(c("solid", "dashed", "dotted", "dotdash"), unique_scenarios)) +
  scale_linetype_manual(name = "Scenario", values = setNames(custom_linetypes, unique_scenarios)) +
  guides(
    linetype = guide_legend(
      title = "Line Type",
      override.aes = list(size = 1)
    )
  ) +
  theme(
    # legend.background = element_rect(fill = "#a4a0a0", color = "white"),
    legend.key = element_rect(fill = "#b5b1b1", color = "white"),
    legend.key.size = unit(30, "points"),
    legend.spacing.x = unit(40, "points"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    axis.title.x = element_text(size = 13),
    axis.title.y = element_text(size = 13),
    axis.text = element_text(size = 12),
    plot.title = element_text(size = 14),
    )
#save
# ggsave("figs/areaplot_shares_ccs.png", width = 8, height = 5, dpi = 300)
```