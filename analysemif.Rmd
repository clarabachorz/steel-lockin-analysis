```{R setup, include = FALSE}
path <- "C:/Users/claraba/Documents/PhD_work/Papers/SteelREMIND/AnalysisScript/"
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(
    root.dir = path
    )

require(ggplot2)
require(tidyverse)
require(mrremind)
require(magclass)
library(waterfalls)
require("quitte")

library("quitte")
library(dplyr)
library(gridExtra)
library(grid)
library(purrr)
```

```{R load data}
mifdata1 <- read.quitte("inputdata/mif/REMIND_generic_GreenPolicy-NPi.mif")

mifdata2 <- read.quitte("inputdata/mif/REMIND_generic_GreenPolicy_noReliningForSomeRegions-PkBudg820.mif")

mifdata3 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended-PkBudg820.mif")


mifdata4 <- read.quitte("inputdata/mif/REMIND_generic_GreenPolicy-PkBudg820.mif")
# mifdata3 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended_expensiveH2-2-PkBudg650.mif")

# mifdata4 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended_moreCCS-PkBudg650.mif")
# mifdata5 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended_moreBFCCS-PkBudg650.mif")
# mifdata6 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended_moreCCS_BFCCSEarlyReti-PkBudg650.mif")

# #other lock in scenarios
# mifdata7 <- read.quitte("inputdata/mif/REMIND_generic_GreenPolicyEarlyReti-PkBudg650.mif")
# mifdata8 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended-PkBudg1000.mif")
# mifdata9 <- read.quitte("inputdata/mif/REMIND_generic_GreenPolicyEarlyReti-PkBudg1000.mif")


# # #"default" scen. NPi?
# mifdata11 <- read.quitte("inputdata/mif/REMIND_generic_GreenPolicy-NPi.mif") %>%
#   mutate(scenario= "default") %>%
#   filter(variable == "Production|Industry|Steel|Primary") %>% #use primary production only
#   filter(between(period, 2020, 2100)) %>% 
#   arrange(region,period)

# write.csv(mifdata11, "primary_steel_prod_default.csv")

mifdata1 <- mifdata1 %>%
  mutate(scenario = "NPi")
  # mutate(scenario = "Policy Extended Transition")

mifdata2 <- mifdata2 %>%
  mutate(scenario = "Fast transition")

mifdata3 <- mifdata3 %>%
  mutate(scenario = "Extended lock-in")

mifdata4 <- mifdata4 %>%
  mutate(scenario = "Green Policy")

# mifdata5 <- mifdata5 %>%
#   mutate(scenario = "Early retirement of BF-BOF-CCS")

# mifdata6 <- mifdata6 %>%
#   mutate(scenario = "More CCS injection capacity +\nearly retirement of BF-BOF-CCS")

# mifdata7 <- mifdata7 %>%
#   mutate(scenario = "Green Policy (1.5C)")

# mifdata8 <- mifdata8 %>%
#   mutate(scenario = "Base scenario (WB2C)")

# mifdata9 <- mifdata9 %>%
#   mutate(scenario = "Green Policy (WB2C)")

# mifdata10 <- mifdata1 %>%
#   mutate(scenario = "Base scenario (1.5C)")


```

```{R plot params, echo = FALSE}	

fs = 10 # font size

steel_route <- tribble(
  ~route,          ~route_name, ~color,
  "DRI-NG-EAF-CCS", "DRI-EAF NG CCS",    "#8fd1af",
  "DRI-NG-EAF",     "DRI-EAF NG",    "#06b429",
  "DRI-H2-EAF",     "DRI-EAF H2",    "#17cff0",
    "BF-BOF-CCS",     "BF-BOF CCS",    "#a0a0a0",
  "BF-BOF",         "BF-BOF",    "#080808",
  "SCRAP-EAF",        "Scrap EAF",   "#fbd30d",
)
```

```{R change data, echo = FALSE}

base_list <- list(mifdata1, mifdata2, mifdata3)
india_list <- list(mifdata3, mifdata4)
test_list <- list(mifdata2, mifdata4)

# h2_list <- list(mifdata1, mifdata2)
# ccs_list <- list(mifdata1, mifdata4, mifdata5, mifdata6)

# lockin_list <- list(mifdata10, mifdata7, mifdata8, mifdata9)

#filter breakdown of steel production
process_data <- function(df) {
  df %>%
    filter(grepl("Production|Industry|Steel|+", variable, ignore.case = TRUE, fixed = TRUE)) %>%
    filter(region == "World", unit == "Mt/yr") %>%
    filter(between(period, 2020, 2100)) %>%
    mutate(variable = gsub("Production|Industry|Steel|+", "", variable)) %>%
    mutate(variable = sub("^\\|\\|\\|\\+\\|", "", variable, fixed = FALSE)) %>%
    filter(variable != "SCRAP-EAF") #remove secondary steel
}

process_data_ccs <- function(df) {
  df %>%
    filter(grepl("Production|Industry|Steel|+", variable, ignore.case = TRUE, fixed = TRUE)) %>%
    filter(between(period, 2020, 2100)) %>%
    mutate(variable = gsub("Production|Industry|Steel|+", "", variable)) %>%
    mutate(variable = sub("^\\|\\|\\|\\+\\|", "", variable, fixed = FALSE)) %>%
    filter(variable != "SCRAP-EAF") #remove secondary steel
}

process_data_lockin <- function(df) {
  df %>%
    filter(grepl("Production|Industry|Steel|+", variable, ignore.case = TRUE, fixed = TRUE)) %>%
    filter(region == "World", unit == "Mt/yr") %>%
    filter(between(period, 2020, 2100)) %>%
    mutate(variable = gsub("Production|Industry|Steel|+", "", variable)) %>%
    mutate(variable = sub("^\\|\\|\\|\\+\\|", "", variable, fixed = FALSE)) %>%
    filter(variable != "SCRAP-EAF") #remove secondary steel
}


```

```{R plot global barplots}

target_labels <- list(
  "1.5C" = "Steel sector transition for a 1.5째C target (with overshoot)",
  "WB2C" = "Steel sector transition for a well below 2째C target"
)

target_labeller = function(variable, value) {
  return(target_labels[value])
}

route_colors <- setNames(steel_route$color, steel_route$route)

mainscens_df_plot <- mainscens_df %>%
  filter(period %in% c(2020,2025, 2030, 2035, 2040, 2045, 2050, 2055,2060)) %>%
  # filter(grepl("1.5C", scenario, ignore.case = TRUE, fixed = TRUE)) %>%
  mutate(
    target = str_extract(scenario, "1\\.5C|WB2C"),
    scenario_clean = gsub("\\(1\\.5C\\)|\\(WB2C\\)", "", scenario),
    period_scenario = paste(period, scenario_clean)
    ) %>%
  arrange(period, scenario) %>%
  mutate(
  period_scenario = factor(period_scenario, levels = unique(period_scenario)),
  target = factor(target, levels = c("1.5C", "WB2C"))
  )


scenario_x_offsets <- mainscens_df_plot %>%
  distinct(scenario_clean) %>%
  arrange(scenario_clean) %>%
  mutate(offset = seq(-0.8,0.8,length.out = n()))

mainscens_df_plot <- mainscens_df_plot %>%
  left_join(scenario_x_offsets, by = "scenario_clean") %>%
  mutate(xpos = as.numeric(period) + offset)

# custom x labels
xlabels_df <- mainscens_df_plot %>%
  distinct(xpos, scenario_clean)

#dates
dates_df <- mainscens_df_plot %>%
  filter(target == "WB2C") %>%
  group_by(period,target) %>%
  summarise(x= mean(xpos)) %>%
  mutate(
    grob = lapply(period, function(lbl){
      textGrob(lbl, gp = gpar(fontsize = fs+2, fontface = "bold"))
    }),
    xmin = x - 1.9,
    xmax = x + 0.5,
    ymin = -960,
    ymax = -960,
  )

# ggplot(mainscens_df_plot, aes(x=period_scenario, y = value, fill = variable)) +
p <- ggplot(mainscens_df_plot, aes(x = xpos, y = value, fill = variable)) +
  geom_bar(
    stat = "identity",
    ) +
  scale_fill_manual(values = route_colors) +
  facet_wrap(~target, ncol = 1, labeller = target_labeller) +
  scale_x_continuous(
    breaks = xlabels_df$xpos,
    labels = xlabels_df$scenario_clean,
    expand = c(0, 0)
  ) +
  labs(
    x = "Scenario and period",
    y = "Steel production (Mt/yr)",
    fill = "Production route") +
  theme_bw(base_size = fs+5) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    plot.margin = margin(10, 10, 30, 10),
    axis.title.x = element_text(margin = margin(t = 25)),
    strip.text = element_text(size = fs+3, face = "bold"),
  ) +
  coord_cartesian(clip = "off")

for (i in seq_len(nrow(dates_df))) {
  p <- p + annotation_custom(
    dates_df$grob[[i]],
    xmin = dates_df$xmin[i],
    xmax = dates_df$xmax[i],
    ymin = dates_df$ymin[i],
    ymax = dates_df$ymax[i]
  )
}
p
# ggsave("figs_temp/steel_production_scenarios.png", width = 12, height = 10, dpi = 300)
```

```{R calc cumu em}
calc_cumuem <- function(df, region_to_calculate) {
  df %>%
    filter(grepl("Emi|CO2|Energy|Demand|Industry|Steel|+",
                # "Emi|CO2|Energy|Demand|Industry|Steel", # if we want the breakdown of what kind of liquids etc
                 variable,
                 ignore.case = TRUE, 
                 fixed = TRUE)) %>%
    # filter(between(period, 2025, 2070),
    filter(between(period, 2025, 2070),
           region == region_to_calculate) %>%
    select(-model, -region) %>%
    #add up the different components: solid, liquids ..
    group_by(period, scenario) %>%
    summarise(total_CO2_yearly = sum(value, na.rm = TRUE),
          total_CO2_5year = total_CO2_yearly * 5) %>%
    ungroup() %>%
    group_by(scenario) %>%
    mutate(cumu_CO2 = cumsum(total_CO2_5year)) %>%
    summarise(cumu_CO2 = max(cumu_CO2))
}


calc_em <- function(df) {
  df %>%
    filter(grepl("Emi|CO2|Energy|Demand|Industry|Steel|+",
                # "Emi|CO2|Energy|Demand|Industry|Steel", # if we want the breakdown of what kind of liquids etc
                 variable,
                 ignore.case = TRUE, 
                 fixed = TRUE)) %>%
    # filter(between(period, 2025, 2070),
    filter(between(period, 2025, 2070)) %>%
    select(-model) %>%
    #add up the different components: solid, liquids ..
    group_by(period, scenario, region) %>%
    summarise(total_CO2_yearly = sum(value, na.rm = TRUE),
          total_CO2_5year = total_CO2_yearly * 5)
}

# ccsscen_emi_df <- ccs_list %>%
#   map_dfr(calc_cumuem) 

mainscens_df_emi <- base_list %>%
  map_dfr(calc_cumuem, region_to_calculate = "World")

mainscens_df_emi_notcumu <- base_list %>%
  map_dfr(calc_em)

indiascens_df_emi <- india_list %>%
  map_dfr(calc_cumuem, region_to_calculate = "IND")

indiascens_df_emi_notcumu <- india_list %>%
  map_dfr(calc_em)

testscens_df_eminotcumu <- test_list %>%
  map_dfr(calc_em)

```


```{R plot base cumu emi}
# Copy the data
mainscens_emi_df_plot <- mainscens_df_emi %>%
  mutate(cumu_CO2 = cumu_CO2 / 1e3)  # Convert to Gt CO2

# Get unique scenario names
unique_scenarios <- c(unique(mainscens_emi_df_plot$scenario))
co2_emissions <- c(mainscens_emi_df_plot$cumu_CO2)

# Convert to factor
mainscens_emi_df_plot$scenario <- factor(mainscens_emi_df_plot$scenario, levels = unique_scenarios)


# # find x-coordinates of bars
x_base <- which(levels(mainscens_emi_df_plot$scenario) == unique_scenarios[1])
x_others <- which(levels(mainscens_emi_df_plot$scenario) != unique_scenarios[1])


y1 <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == unique_scenarios[1]]
y2 <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == unique_scenarios[2]]
y3 <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == unique_scenarios[3]]
# y2 <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == "Base scenario (WB2C)"] / 1e3


# emi_1p5diff <- y1- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == "Green Policy (1.5C)"] / 1e3
# emi_wb2cdiff <- y2-mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == "Green Policy (WB2C)"] / 1e3

# # find y-coordinates for arrows
y_base <- y1 + 5  # slightly above base bar
# y_others <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario != "Base scenario (1.5C)"] / 1e3 + 30



# Plot
ggplot(mainscens_emi_df_plot, aes(x = scenario, y = cumu_CO2, fill = scenario)) +
  geom_bar(stat = "identity", width = 0.6) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 20)) +
  # scale_fill_manual(values = c("#d7a614", "#3fa60e", "#bb5700", "#1a7213")) +
  scale_fill_manual(values = c("#88CCEE", "#FDB863", "#D55E00")) +
  labs(
    title = "Cumulative CO2 Emissions (2025-2070)\nfrom steel production, by scenario",
    x = "Scenario",
    y = "Cumulative CO2 (Gt CO2)"
  ) +
  theme_classic(base_size = fs+3) +
  guides(fill = "none") +
  scale_y_continuous(
    name = "Cumulative CO2 (Gt CO2)",
    sec.axis = sec_axis(~ ((. / 585)) * 100, name = "Fraction of remaining well-below 2째C carbon budget (%)")
  ) +
  theme(
    text = element_text(size = 9),
    title = element_text(size = 11),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 9),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.grid.major = element_line(linetype = "dashed", color = "gray70")
  ) +
  annotate("text", x = (x_base*1), y = y_base,
            label = paste0("", round(co2_emissions[1], 0), " GtCO2"), size = 3, fontface = "bold", color = "#7e7e7e") +
  annotate("text", x = (x_base*2), y = y2 +5,
            label = paste0("", round(co2_emissions[2], 0), " GtCO2"), size = 3, fontface = "bold", color = "#7e7e7e") +
  annotate("text", x = (x_base*3), y = y3 +5,
           label = paste0("", round(co2_emissions[3], 0), " GtCO2"), size = 3, fontface = "bold", color = "#7e7e7e")

#save
# ggsave("figs_temp/cumu_emi_base_scen.png", width = 5, height = 5, dpi = 300)

```

```{R plot base cumu emi}

scenario_order <- c("Green Policy", "Extended lock-in")

# Copy the data
mainscens_emi_df_plot <- indiascens_df_emi %>%
  mutate(cumu_CO2 = cumu_CO2 / 1e3)   # Convert to Gt CO2

# Get unique scenario names
unique_scenarios <- c(unique(mainscens_emi_df_plot$scenario))

# Convert to factor
mainscens_emi_df_plot$scenario <- factor(mainscens_emi_df_plot$scenario, levels = scenario_order)

#order columns the expected way and grab cumulative CO2 emissions
mainscens_emi_df_plot <-  mainscens_emi_df_plot[order(mainscens_emi_df_plot$scenario),]
co2_emissions <- c(mainscens_emi_df_plot$cumu_CO2)


# # find x-coordinates of bars
x_base <- which(levels(mainscens_emi_df_plot$scenario) == unique_scenarios[1])
x_others <- which(levels(mainscens_emi_df_plot$scenario) != unique_scenarios[1])


y1 <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == scenario_order[1]]
y2 <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario == scenario_order[2]]
#
# # find y-coordinates for arrows
y_base <- y1 + 1  # slightly above base bar
# y_others <- mainscens_emi_df_plot$cumu_CO2[mainscens_emi_df_plot$scenario != "Base scenario (1.5C)"] / 1e3 + 30

fs <- 12	


# Plot
ggplot(mainscens_emi_df_plot, aes(x = scenario, y = cumu_CO2, fill = scenario)) +
  geom_bar(stat = "identity", width = 0.6) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 20)) +
  # scale_fill_manual(values = c("#d7a614", "#3fa60e", "#bb5700", "#1a7213")) +
  scale_fill_manual(values = c("#88CCEE", "#D55E00")) +
  labs(
    title = "Cumulative CO2 Emissions in India (2025-2070)\nfrom steel production, by scenario",
    x = "Scenario",
    y = "Cumulative CO2 (Gt CO2)"
  ) +
  theme_classic(base_size = fs+3) +
  guides(fill = "none") +
  scale_y_continuous(
    name = "Cumulative CO2 (Gt CO2)",
    sec.axis = sec_axis(~ ((. / 585)) * 100, name = "Fraction of remaining well-below 2째C carbon budget (%)")
  ) +
  theme(
    text = element_text(size = 9),
    title = element_text(size = 11),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 9),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.grid.major = element_line(linetype = "dashed", color = "gray70")
  ) +
  annotate("text", x = (x_base*0.5), y = y_base,
            label = paste0("", round(co2_emissions[1], 0), " GtCO2"), size = 3, fontface = "bold", color = "#7e7e7e") +
  annotate("text", x = (x_base*1), y = y2 +1,
            label = paste0("", round(co2_emissions[2], 0), " GtCO2"), size = 3, fontface = "bold", color = "#7e7e7e")
#save
# ggsave("figs_temp/cumu_emi_india_scen.png", width = 5, height = 5, dpi = 300)

```

```{R}

region_colors = c(
  "CHA" = "#e41818",
  "IND"="#e48108",
  "JPN"="#d4c7b1",
  "OAS"="#c9b60d",
  "USA"="#08a0e4",
  "EUR"="#0912c3",
  "NEU"="#c9b60d",
  "REF"="#aac90d",
  "SSA"="#0dc90d",
  "LAM"="#c90dbc",
  "MEA"="#8340c2",
  "CAZ"="#08e4a0")

plot_df <- mainscens_df_emi_notcumu %>%
  filter(region != "World") %>% #filter out world
  group_by(region, scenario) %>%
  arrange(period) %>%
  mutate(cumuCO2 = cumsum(total_CO2_5year)) %>%
  select(period, scenario, region, cumuCO2) %>%
  ungroup()

#order by largest area
last_period <- max(plot_df$period)

region_order <- plot_df %>%
  filter(period == last_period) %>%
  group_by(region) %>%
  summarise(cumuCO2 = max(cumuCO2), .groups = "drop") %>%
  arrange(-cumuCO2) %>%
  pull(region)

plot_df$region <- factor(plot_df$region, levels = region_order)
plot_df$scenario <- factor(plot_df$scenario, levels = c("NPi", "Extended lock-in", "Fast transition"))

plot_df <- plot_df %>%
  filter(period == 2060)

#plot area plot of cumulative emissions
ggplot(plot_df, aes(x = scenario, y = cumuCO2 / 1e3, fill = region)) +
  geom_bar(position="stack", stat="identity", alpha = 0.8) +
  labs(title = "Cumulative CO2 Emissions from steel production in 2060 (2025 to 2060)",
       x = "Year",
       y = "Cumulative CO2 Emissions (Gt CO2)",
       fill = "Region") +
  scale_fill_manual(values =region_colors) +
  theme_minimal(base_size = 14)
```
```{R cascacde cumulative emissions}


region_order = c(
  "CHA" = "#e41818",
  "IND"="#e48108",
  "OAS"="#c9b60d",
  "SSA"="#0dc90d",
  "REF"="#aac90d",
  "LAM"="#c90dbc",
  "JPN"="#d4c7b1",
  "MEA"="#8340c2",
  "USA"="#08a0e4",
  "EUR"="#0912c3",
  "NEU"="#c9b60d",
  "CAZ"="#08e4a0")


#get region colors from list above
region_colors <- c(
  "NPi" = "grey", "Extended lock-in" = "grey", "Fast transition" = "grey",
  region_order,
  setNames(region_order, paste0(names(region_order), "_2"))
)


# Prepare data with total cumulative emissions and region contributions
plot_df <- mainscens_df_emi_notcumu %>%
  filter(region != "World") %>%
  group_by(region, scenario) %>%
  arrange(period) %>%
  mutate(cumuCO2 = cumsum(total_CO2_5year)) %>%
  ungroup() %>%
  filter(period == 2060) %>%
  mutate(cumuCO2 = cumuCO2 / 1e3) # Convert to Gt CO2

plot_df$region <- factor(plot_df$region, levels = names(region_order))
plot_df$scenario <- factor(plot_df$scenario, levels = c("NPi", "Extended lock-in", "Fast transition"))

# Get total emissions by scenario
total_df <- plot_df %>%
  group_by(scenario) %>%
  summarise(total = sum(cumuCO2), .groups = "drop")

# Compute differences between scenarios by region for the cascade
cascade_df <- plot_df %>%
  select(region, scenario, cumuCO2) %>%
  mutate(region = factor(region, levels = names(region_order))) %>%
  arrange(region, scenario) %>%
  group_by(region) %>%
  mutate(diff = cumuCO2 - lag(cumuCO2, default = first(cumuCO2))) %>%
  ungroup()

# Build waterfall data: baseline total, region contributions, final totals
waterfall_data <- bind_rows(
  tibble(label = "NPi", value = total_df$total[total_df$scenario == "NPi"], type = "total"),
  cascade_df %>% filter(scenario == "Extended lock-in") %>% mutate(label = region, value = diff, type = "region") %>% select(label, value, type),
  # tibble(label = "Extended lock-in", value = total_df$total[total_df$scenario == "Extended lock-in"], type = "total"),
  tibble(label = "Extended lock-in", value = FALSE, type = "total"),
  cascade_df %>% filter(scenario == "Fast transition") %>%
    mutate(label = paste0(region, "_2"), value = diff, type = "region") %>%
    select(label, value, type),
  # tibble(label = "Fast transition", value = total_df$total[total_df$scenario == "Fast transition"], type = "total")
  tibble(label = "Fast transition", value = 0, type = "total")
)

waterfall_data <- waterfall_data %>%
  mutate(color = region_colors[label]) %>%
  #remove useless "0" for the scenario totals
  mutate(label2 = ifelse(type == "total", "", paste0(round(value, 1)))) %>%
  #remove "_2" with hacky extra space:
  # mutate(label = gsub("_2", " ", label)) %>%
  select(label, value, type, label2, color) %>%
  mutate(label = factor(label, levels = names(region_colors)))

# custom x ticks
labels_vec <- as.character(waterfall_data$label)
labels_vec <- ifelse(labels_vec %in% c("NPi", "Extended lock-in", "Fast transition"), labels_vec, " ")


# Create waterfall chart using ggwaterfall
wf_plot <- waterfall(waterfall_data, 
          rect_text_labels =waterfall_data$label2,
          fill_by_sign = FALSE, fill_colours = waterfall_data$color) +
  # scale_x_discrete(labels = label_fun)+
  labs(
    title = "Breakdown of cumulative CO2 Emissions from steel production in 2060 (2025 to 2060)",
    x = "Scenario",
    y = "Cumulative emissions (Gt CO2)",
    fill = "Region"
  ) +
  theme_bw(base_size = 14)

plot_df <- plot_df %>%
  filter(period == 2060) %>%
  mutate(x_pos = ifelse(scenario == "NPi", 1, ifelse(scenario == "Extended lock-in", 14, 27))) #%>%

wf_plot +
  geom_bar(data = plot_df,
          aes(x = x_pos, y = cumuCO2, fill = region), 
          width = 0.7,position="stack", stat="identity", alpha = 0.8, color = "black") +
  scale_fill_manual(values =region_colors) +
  scale_x_discrete(labels = labels_vec) +
  theme(
    panel.border = element_blank(),
    panel.grid.major = element_line(linewidth = 0.3, color = "#dbd8d8"),
    panel.grid.minor = element_blank(),
    axis.ticks = element_blank())
  #sub in basic grey bars instead
  # geom_col(data = total_df %>% filter(scenario == "Extended lock-in"),
  #          aes(x = 14, y = total),
  #          fill = "grey", color = "black", width = 0.7) +
  # geom_col(data = total_df %>% filter(scenario == "Fast transition"),
  #          aes(x = 27, y = total),
  #          fill = "grey", color = "black", width = 0.7)

# ggsave("figs_temp/cascade_cumu_emi_scen.png", width = 12, height = 8, dpi = 300)

```


```{R cascacde yearly emissions}


region_order = c(
  "CHA" = "#e41818",
  "IND"="#e48108",
  "OAS"="#c9b60d",
  "SSA"="#0dc90d",
  "REF"="#aac90d",
  "LAM"="#c90dbc",
  "JPN"="#d4c7b1",
  "MEA"="#8340c2",
  "USA"="#08a0e4",
  "EUR"="#0912c3",
  "NEU"="#c9b60d",
  "CAZ"="#08e4a0")


#get region colors from list above
region_colors <- c(
  "NPi" = "grey", "Extended lock-in" = "grey", "Fast transition" = "grey",
  region_order,
  setNames(region_order, paste0(names(region_order), "_2"))
)


# Prepare data with total cumulative emissions and region contributions
plot_df <- mainscens_df_emi_notcumu %>%
  filter(region != "World") %>%
  select(period, scenario, region, total_CO2_yearly) %>%
  filter(period == 2050) %>%
  mutate(total_CO2_yearly = total_CO2_yearly / 1e3) # Convert to Gt CO2


plot_df$region <- factor(plot_df$region, levels = names(region_order))
plot_df$scenario <- factor(plot_df$scenario, levels = c("NPi", "Extended lock-in", "Fast transition"))

# Get total emissions by scenario
total_df <- plot_df %>%
  group_by(scenario) %>%
  summarise(total = sum(total_CO2_yearly), .groups = "drop")

# Compute differences between scenarios by region for the cascade
cascade_df <- plot_df %>%
  select(region, scenario, total_CO2_yearly) %>%
  mutate(region = factor(region, levels = names(region_order))) %>%
  arrange(region, scenario) %>%
  group_by(region) %>%
  mutate(diff = total_CO2_yearly - lag(total_CO2_yearly, default = first(total_CO2_yearly))) %>%
  ungroup()

# Build waterfall data: baseline total, region contributions, final totals
waterfall_data <- bind_rows(
  tibble(label = "NPi", value = total_df$total[total_df$scenario == "NPi"], type = "total"),
  cascade_df %>% filter(scenario == "Extended lock-in") %>% mutate(label = region, value = diff, type = "region") %>% select(label, value, type),
  # tibble(label = "Extended lock-in", value = total_df$total[total_df$scenario == "Extended lock-in"], type = "total"),
  tibble(label = "Extended lock-in", value = FALSE, type = "total"),
  cascade_df %>% filter(scenario == "Fast transition") %>%
    mutate(label = paste0(region, "_2"), value = diff, type = "region") %>%
    select(label, value, type),
  # tibble(label = "Fast transition", value = total_df$total[total_df$scenario == "Fast transition"], type = "total")
  tibble(label = "Fast transition", value = 0, type = "total")
)

waterfall_data <- waterfall_data %>%
  mutate(color = region_colors[label]) %>%
  #remove useless "0" for the scenario totals
  mutate(label2 = ifelse(type == "total", "", paste0(round(value, 1)))) %>%
  #remove "_2" with hacky extra space:
  # mutate(label = gsub("_2", " ", label)) %>%
  select(label, value, type, label2, color) %>%
  mutate(label = factor(label, levels = names(region_colors)))

# custom x ticks
labels_vec <- as.character(waterfall_data$label)
labels_vec <- ifelse(labels_vec %in% c("NPi", "Extended lock-in", "Fast transition"), labels_vec, " ")


# Create waterfall chart using ggwaterfall
wf_plot <- waterfall(waterfall_data, 
          rect_text_labels =waterfall_data$label2,
          fill_by_sign = FALSE, fill_colours = waterfall_data$color) +
  # scale_x_discrete(labels = label_fun)+
  labs(
    title = "Breakdown of yearly CO2 Emissions from steel production in 2050",
    x = "Scenario",
    y = "Yearly emissions (Gt CO2/yr)",
    fill = "Region"
  ) +
  theme_bw(base_size = 14)

plot_df <- plot_df %>%
  filter(period == 2050) %>%
  mutate(x_pos = ifelse(scenario == "NPi", 1, ifelse(scenario == "Extended lock-in", 14, 27))) #%>%

wf_plot +
  geom_bar(data = plot_df,
          aes(x = x_pos, y = total_CO2_yearly, fill = region), 
          width = 0.7,position="stack", stat="identity", alpha = 0.8, color = "black") +
  scale_fill_manual(values =region_colors) +
  scale_x_discrete(labels = labels_vec) +
  theme(
    panel.border = element_blank(),
    panel.grid.major = element_line(linewidth = 0.3, color = "#dbd8d8"),
    panel.grid.minor = element_blank(),
    axis.ticks = element_blank())
  #sub in basic grey bars instead
  # geom_col(data = total_df %>% filter(scenario == "Extended lock-in"),
  #          aes(x = 14, y = total),
  #          fill = "grey", color = "black", width = 0.7) +
  # geom_col(data = total_df %>% filter(scenario == "Fast transition"),
  #          aes(x = 27, y = total),
  #          fill = "grey", color = "black", width = 0.7)

# ggsave("figs_temp/cascade_yearly_emi_scen.png", width = 12, height = 8, dpi = 300)
```


```{R}

plot_emi_notcumu <- indiascens_df_emi_notcumu %>%
  filter(region == "IND") %>%
  select(-region)

#plot annual emissions (Gt per year) for all regions
#facet is region
p <- ggplot(plot_emi_notcumu) +
  geom_line(aes(x = period, y = total_CO2_yearly, color = scenario), size = 0.6) + #to GtCO2
  geom_point(aes(x = period, y = total_CO2_yearly, color = scenario), size = 2, shape = 21, fill = "white", stroke = 0.8) +
  labs(title = "Annual CO2 Emissions from Steel Production in India (2025-2070) by scenario",
       x = "Year",
       y = "CO2 Emissions (Mt CO2)",
       color = "Scenario") +
  scale_color_manual(values = c(
    "Extended lock-in" = "#4d4d50",
    "Fast transition"="#c9b60d",
    "Green Policy"="#0dc962")) +
  theme_minimal(base_size = 14)

p
```
