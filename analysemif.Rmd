```{r setup, include = FALSE}
path <- "C:/Users/claraba/Documents/PhD_work/Papers/SteelREMIND/AnalysisScript/"
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(
    root.dir = path
    )

require(ggplot2)
require(tidyverse)
require(mrremind)
require(magclass)
require(quitte)
library("quitte")
library(dplyr)
library(gridExtra)
library(grid)
library(purrr)
```

```{r load data}
mifdata1 <- read.quitte("inputdata/mif/REMIND_generic_SteelCapBoundNoRetiReliningGovTarget-PkBudg650.mif")
mifdata2 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended_expensiveH2-1-PkBudg650.mif")
mifdata3 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended_expensiveH2-2-PkBudg650.mif")

mifdata4 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended_moreCCS-PkBudg650.mif")
mifdata5 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended_moreBFCCS-PkBudg650.mif")
mifdata6 <- read.quitte("inputdata/mif/REMIND_generic_PolicyExtended_moreCCS_BFCCSEarlyReti-PkBudg650.mif")

#other lock in scenarios
mifdata7 <- read.quitte("inputdata/mif/REMIND_generic_SteelCapBound-PkBudg650.mif")
mifdata8 <- read.quitte("inputdata/mif/REMIND_generic_SteelCapBoundNoReti-PkBudg650.mif")
mifdata9 <- read.quitte("inputdata/mif/REMIND_generic_SteelCapBoundNoRetiRelining-PkBudg650.mif")

mifdata1 <- mifdata1 %>%
  mutate(scenario = "Base H2 cost")
  # mutate(scenario = "Policy Extended Transition")

mifdata2 <- mifdata2 %>%
  mutate(scenario = "High H2 cost")

mifdata3 <- mifdata3 %>%
  mutate(scenario = "Very high H2 cost")

mifdata4 <- mifdata4 %>%
  mutate(scenario = "More CCS injection capacity")

mifdata5 <- mifdata5 %>%
  mutate(scenario = "Early retirement of BF-BOF-CCS")

mifdata6 <- mifdata6 %>%
  mutate(scenario = "More CCS injection capacity +\nearly retirement of BF-BOF-CCS")

mifdata7 <- mifdata7 %>%
  mutate(scenario = "Early Transition")

mifdata8 <- mifdata8 %>%
  mutate(scenario = "Base Transition")

mifdata9 <- mifdata9 %>%
  mutate(scenario = "Extended Lifetime Transition")

```

```{r plot params, echo = FALSE}	

fs = 10 # font size

steel_route <- tribble(
  ~route,          ~route_name, ~color,
  "BF-BOF",         "BF-BOF",    "#080808",
  "BF-BOF-CCS",     "BF-BOF CCS",    "#a0a0a0",
  "DRI-NG-EAF-CCS", "DRI-EAF NG CCS",    "#8fd1af",
  "DRI-NG-EAF",     "DRI-EAF NG",    "#06b429",
  "DRI-H2-EAF",     "DRI-EAF H2",    "#17cff0",
  "SCRAP-EAF",        "Scrap EAF",   "#fbfb0d",
)
```

```{r change data, echo = FALSE}

mifdata_list <- list(mifdata1, mifdata2, mifdata3)
ccs_list <- list(mifdata1, mifdata4, mifdata5, mifdata6)

lockin_list <- list(mifdata1,mifdata7, mifdata8, mifdata9)

#filter breakdown of steel production
process_data <- function(df) {
  df %>%
    filter(grepl("Production|Industry|Steel|+", variable, ignore.case = TRUE, fixed = TRUE)) %>%
    filter(region == "World", unit == "Mt/yr") %>%
    filter(between(period, 2020, 2100)) %>%
    mutate(variable = gsub("Production|Industry|Steel|+", "", variable)) %>%
    mutate(variable = sub("^\\|\\|\\|\\+\\|", "", variable, fixed = FALSE)) 
    # %>%
    # filter(variable != "SCRAP-EAF") #remove secondary steel
}

process_data_ccs <- function(df) {
  df %>%
    filter(grepl("Production|Industry|Steel|+", variable, ignore.case = TRUE, fixed = TRUE)) %>%
    filter(between(period, 2020, 2100)) %>%
    mutate(variable = gsub("Production|Industry|Steel|+", "", variable)) %>%
    mutate(variable = sub("^\\|\\|\\|\\+\\|", "", variable, fixed = FALSE)) %>%
    filter(variable != "SCRAP-EAF") #remove secondary steel
}

process_data_lockin <- function(df) {
  df %>%
    filter(grepl("Production|Industry|Steel|+", variable, ignore.case = TRUE, fixed = TRUE)) %>%
    filter(region == "World", unit == "Mt/yr") %>%
    filter(between(period, 2020, 2100)) %>%
    mutate(variable = gsub("Production|Industry|Steel|+", "", variable)) %>%
    mutate(variable = sub("^\\|\\|\\|\\+\\|", "", variable, fixed = FALSE)) %>%
    filter(variable != "SCRAP-EAF") #remove secondary steel
}

#get full df
prsteel_df <- mifdata_list %>%
  map_dfr(process_data)

ccsscen_df <- ccs_list %>%
  map_dfr(process_data_ccs)

lockin_df <- lockin_list %>%
  map_dfr(process_data_lockin)

#calculate h2 shareh2_ in total primary steel
h2_share <- prsteel_df %>%
  group_by(period, scenario) %>%
  summarise(h2_share = sum(value[variable == "DRI-H2-EAF"]) / sum(value)) %>%
  mutate(h2_share = h2_share*100) #to percent 

h2_share_lockin <- lockin_df %>%
  group_by(period, scenario) %>%
  summarise(h2_share = sum(value[variable == "DRI-H2-EAF"]) / sum(value)) %>%
  mutate(h2_share = h2_share*100) #to percent

#calculate amount of H2 dri
h2_dri <- prsteel_df %>%
  filter(variable == "DRI-H2-EAF") %>%
  group_by(period, scenario) %>%
  summarise(value = sum(value))

ccs_share <- ccsscen_df %>%
  group_by(period, scenario, region) %>%
  summarise(ccs_share = sum(value[variable == "BF-BOF-CCS"]) / sum(value)) %>%
  mutate(ccs_share = ccs_share*100) #to percent

all_steel_shares <- ccsscen_df %>%
  group_by(period, scenario, region) %>%
  summarise(
    total_production = sum(value, na.rm = TRUE),
    h2_share = sum(value[variable == "DRI-H2-EAF"], na.rm = TRUE) / total_production,
    bf_bof_ccs_share = sum(value[variable == "BF-BOF-CCS"], na.rm = TRUE) / total_production,
    bf_bof_share = sum(value[variable == "BF-BOF"], na.rm = TRUE) / total_production,
    ng_share = sum(value[variable == "DRI-NG-EAF"], na.rm = TRUE) / total_production
  )

head(all_steel_shares)


```

```{r plot h2 share, echo = FALSE}

h2_share_plot <- h2_share

#factors for scenarios
# h2_share_plot$scenario <- factor(h2_share_plot$scenario, levels = c("Base H2 cost", "High H2 cost", "Very high H2 cost"))


#make line plot of h2 share, one line for each scenario

ggplot(h2_share_plot, aes(x = period, y = h2_share, color = scenario)) +
  geom_line(size = 0.6, alpha = 0.8) +
  geom_point(size = 2, shape = 21, fill = "white", stroke = 0.8) +
  labs(title = "Share of DRI-H2-EAF in total steel production",
       x = "Time",
       y = "DRI-H2-EAF share (%)",
       color = "Scenario") +
  # scale_color_viridis_d(option = "C") +
  scale_color_manual(values = c("#0d55c9", "#22cdbc", "#8586bc", "#3d3d3f","#8d8d92", "#41415d")) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.title = element_text(face = "bold")
  ) +
  guides(color = guide_legend(nrow = 2, byrow = TRUE))

#save
#ggsave("h2_share.png", width = 8, height = 5, dpi = 300)
```

```{r plot h2 share lockin scen, echo = FALSE}

# h2_share_plot <- h2_share_lockin

#factors for scenarios
# h2_share_plot$scenario <- factor(h2_share_plot$scenario, levels = c("Base H2 cost", "High H2 cost", "Very high H2 cost"))


#make line plot of h2 share, one line for each scenario

ggplot(h2_share_lockin, aes(x = period, y = h2_share, color = scenario)) +
  geom_line(size = 0.6, alpha = 0.8) +
  geom_point(size = 2, shape = 21, fill = "white", stroke = 0.8) +
  labs(title = "Share of DRI-H2-EAF in primary steel production",
       x = "Time",
       y = "DRI-H2-EAF share (%)",
       color = "Scenario") +
  # scale_color_viridis_d(option = "C") +
  scale_color_manual(values = c("#7BADAE", "#6E8980", "#757A67", "#8A704E")) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.title = element_text(face = "bold")
  ) +
  guides(color = guide_legend(nrow = 2, byrow = TRUE))

#save
# ggsave("h2_share_lockin.png", width = 8, height = 5, dpi = 300)
```

```{r plot h2 dri, echo = FALSE}

#factors for scenarios
# h2_dri$scenario <- factor(h2_dri$scenario, levels = c("Base H2 cost", "High H2 cost", "Very high H2 cost", "More CCS injection capacity", "More CCS injection capacity +\nearly retirement of BF-BOF-CCS"))



ggplot(h2_dri, aes(x = period, y = value, color = scenario)) +
  geom_line(size = 0.6, alpha = 0.8) +
  geom_point(size = 2, shape = 21, fill = "white", stroke = 0.8) +
  labs(title = "DRI-H2-EAF steel production",
       x = "Time",
       y = "Steel production (Mt/yr)",
       color = "Scenario") +
  # scale_color_viridis_d(option = "C") +
  scale_color_manual(values = c("#0d55c9", "#22cdbc", "#8586bc", "#3d3d3f", "#41415d")) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.title = element_text(face = "bold")
  )+
  guides(color = guide_legend(nrow = 2, byrow = TRUE))

```

```{r plot ccs share, echo = FALSE}

ccs_share_glob <- ccs_share %>%
  filter(region == "World") %>%
  select(-region)

#rename "base H2 cost" to "Base H2 cost"
ccs_share_glob$scenario <- gsub("Base H2 cost", "Base CCS assumption", ccs_share_glob$scenario)

#factors for scenarios
ccs_share_glob$scenario <- factor(ccs_share_glob$scenario, levels = c("Base CCS assumption", "More CCS injection capacity","Early retirement of BF-BOF-CCS", "More CCS injection capacity +\nearly retirement of BF-BOF-CCS"))

#plot
ggplot(ccs_share_glob, aes(x = period, y = ccs_share, color = scenario)) +
  geom_line(size = 0.6, alpha = 1) +
  geom_point(size = 2, shape = 21, fill = "white", stroke = 0.8) +
  labs(title = "Share of BF-BOF-CCS in total primary steel production (World)",
       x = "Time",
       y = "BF-BOF-CCS share (%)",
       color = "Scenario") +
  scale_color_viridis_d(option = "inferno", end = 0.8, direction = -1) +
  #scale_color_manual(values = c("#c6c9cd", "#928166", "#8d5252", "#000000")) +
  #add y limit
  ylim(0, 100) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.title = element_text(face = "bold")
  )+
  guides(color = guide_legend(nrow = 2, byrow = TRUE))

#save
# ggsave("ccs_share_global.png", width = 8, height = 5, dpi = 300)
```

```{r plot ccs share, echo = FALSE}

ccs_share_IND <- ccs_share %>%
  filter(region == "IND") %>%
  select(-region)

#rename "base H2 cost" to "Base H2 cost"
ccs_share_IND$scenario <- gsub("Base H2 cost", "Base CCS assumption", ccs_share_IND$scenario)

#factors for scenarios
ccs_share_IND$scenario <- factor(ccs_shar_INDe$scenario, levels = c("Base CCS assumption", "More CCS injection capacity","Early retirement of BF-BOF-CCS", "More CCS injection capacity +\nearly retirement of BF-BOF-CCS"))

#plot
ggplot(ccs_share_IND, aes(x = period, y = ccs_share, color = scenario)) +
  geom_line(size = 0.6, alpha = 1) +
  geom_point(size = 2, shape = 21, fill = "white", stroke = 0.8) +
  labs(title = "Share of BF-BOF-CCS in total primary steel production (India)",
       x = "Time",
       y = "BF-BOF-CCS share (%)",
       color = "Scenario") +
  scale_color_viridis_d(option = "inferno", end = 0.8) +
  #scale_color_manual(values = c("#c6c9cd", "#928166", "#8d5252", "#000000")) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.title = element_text(face = "bold")
  )+
  guides(color = guide_legend(nrow = 2, byrow = TRUE))

```

```{r plot ccs share, echo = FALSE}

ccs_share_CHA <- ccs_share %>%
  filter(region == "CHA") %>%
  select(-region)

#rename "base H2 cost" to "Base H2 cost"
ccs_share_CHA$scenario <- gsub("Base H2 cost", "Base CCS assumption", ccs_share_CHA$scenario)

#factors for scenarios
ccs_share_CHA$scenario <- factor(ccs_share_CHA$scenario, levels = c("Base CCS assumption", "More CCS injection capacity","Early retirement of BF-BOF-CCS", "More CCS injection capacity +\nearly retirement of BF-BOF-CCS"))

#plot
ggplot(ccs_share_CHA, aes(x = period, y = ccs_share, color = scenario)) +
  geom_line(size = 0.6, alpha = 1) +
  geom_point(size = 2, shape = 21, fill = "white", stroke = 0.8) +
  labs(title = "Share of BF-BOF-CCS in total primary steel production (China)",
       x = "Time",
       y = "BF-BOF-CCS share (%)",
       color = "Scenario") +
  scale_color_viridis_d(option = "inferno", end = 0.8, direction = -1) +
  #scale_color_manual(values = c("#c6c9cd", "#928166", "#8d5252", "#000000")) +
  # theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11),
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.title = element_text(face = "bold")
  )+
  guides(color = guide_legend(nrow = 2, byrow = TRUE))

#save
# ggsave("ccs_share_oas.png", width = 8, height = 5, dpi = 300)
```

```{r plot ccs area plots, echo = FALSE}

plot_df <- all_steel_shares %>%
  filter(region == "World") %>%
  select(-total_production) %>%  # Remove unnecessary column
  pivot_longer(cols = ends_with("_share"), 
               names_to = "steel_route", 
               values_to = "share")  # Convert to long format for ggplot

# Improve steel_route labels
plot_df$steel_route <- recode(plot_df$steel_route,
                              "h2_share" = "DRI-H2-EAF",
                              "bf_bof_ccs_share" = "BF-BOF-CCS",
                              "bf_bof_share" = "BF-BOF",
                              "ng_share" = "DRI-NG-EAF")

plot_df <- plot_df %>%
  left_join(steel_route, by = c("steel_route" = "route"))

plot_df$steel_route <- factor(plot_df$steel_route, 
                              levels = c( "DRI-NG-EAF", "DRI-H2-EAF","BF-BOF-CCS","BF-BOF"))

color_mapping <- setNames(plot_df$color, plot_df$steel_route)

# Plot
ggplot(plot_df, aes(x = period, y = share, fill = steel_route)) +
  geom_area(alpha = 0.7) +  # Stacked area plot
  scale_fill_manual(values = color_mapping) +
  labs(title = "Steel Production Share by Route",
       x = "Year",
       y = "Share (%)",
       fill = "Steel Route") +
  facet_wrap(~scenario) +  # Separate plots for each scenario
  scale_y_continuous(labels = scales::percent_format()) +  # Show % format
  theme_minimal() +
  theme(legend.position = "bottom")



# COMBINED PLOT


# # Create a new column for the combined share of BF-BOF and BF-BOF CCS
plot_df <- plot_df %>%
  group_by(period, scenario) %>%
  mutate(combined_bf_bof_share = sum(share[steel_route %in% c("BF-BOF", "BF-BOF-CCS")])) %>%
  ungroup()


#COMBINE area plots
unique_scenarios <- unique(plot_df$scenario)

# Plot
ggplot() +
  geom_area(data = plot_df %>% filter(scenario == unique_scenarios[1]),
            aes(x = period, y = share, fill = steel_route), alpha = 0.25) +
  geom_area(data = plot_df %>% filter(scenario == unique_scenarios[2]),
            aes(x = period, y = share, fill = steel_route), alpha = 0.25) +
  geom_area(data = plot_df %>% filter(scenario == unique_scenarios[3]),
            aes(x = period, y = share, fill = steel_route), alpha = 0.25) +
  geom_area(data = plot_df %>% filter(scenario == unique_scenarios[4]),
            aes(x = period, y = share, fill = steel_route), alpha = 0.25) +
  scale_fill_manual(values = color_mapping) +
  labs(title = "Steel Production Share by Route",
       x = "Year",
       y = "Share (%)",
       fill = "Steel Route") +
  scale_y_continuous(labels = scales::percent_format()) +  # Show % format
  theme_minimal() +
  # Overlay lines showing combined BF-BOF + BF-BOF CCS share with scenario-dependent linetype
  # geom_line(data = plot_df,
  #           aes(x = period, y = combined_bf_bof_share, group = scenario, color = scenario, linetype = scenario),
  #           size = 1.2) +
  # # Overlay lines showing BF-BOF share with scenario-dependent linetype
  geom_line(data = plot_df %>% filter(steel_route == "BF-BOF"),
            aes(x = period, y = share, group = scenario, color = scenario, linetype = scenario),
            size = 1.2) +
  # Add a legend for the lines
  #color only white
  #scale_color_manual(name = "Scenario", values = setNames(c("#010101", "#ff6200", "#cb0ece", "#ffffff"), unique_scenarios)) +
  scale_linetype_manual(name = "Scenario", values = setNames(c("solid", "dashed", "dotted", "dotdash"), unique_scenarios)) +
  guides(linetype = guide_legend(title = "Line Type"),
        )

```
```{r plot primary steel, echo = FALSE}	

# # Reorder levels of 'variable' factor
plot_df$variable <- factor(plot_df$variable,levels = c(
  "DRI-NG-EAF-CCS",
  "DRI-NG-EAF",
  "DRI-H2-EAF",
  "BF-BOF-CCS",
  "BF-BOF"))

plot_df <- plot_df %>%
  mutate(color = steel_route$color[match(variable, steel_route$route)])

color_mapping <- setNames(steel_route$color[match(levels(plot_df$variable), steel_route$route)], 
                        levels(plot_df$variable))

# Steel production Plot:
# TODO: separate primary and secondary steel somehow
ggplot(plot_df, aes(x = period)) +
  geom_area(aes(y = value, fill = variable), alpha = 0.5) +
  scale_fill_manual(values = color_mapping) +
  labs(title = "Primary Steel production by technology type",
       x = "Time",
       y = "Primary Steel Production (Mt/yr)") +
  theme_minimal()

#Plot steel CO2 emissions intensity + share of secondary steel in total mix on the same graph (different y axes?)

```