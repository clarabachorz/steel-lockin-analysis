# Notebook: Plotting Figure 3


In this notebook, we will plot Figure 3, which compares steel production routes for different regions and periods.


## Preparing notebook


Importing libraries.

```{r}
library(dplyr)
require(tidyverse)
require(ggplot2)
library(gridExtra)
library(grid)
library(purrr)
library(ggpubr)

library(quitte)
library(mip)
```

Define some helper functions:

* Function for creating a sample of a dataframe (helpful for quick inspection).
* Functions for calculating sizes of figures (converting mm and pt to inch).
* Function for exporting image to various formats with correct size and resolution.

```{r}
show_sample <- function (df, nr=10) {
    return(df[sample(nrow(df), nr), ])
}
```

```{r}
dpi <- 300
pt <- function (x) {
    return(x / 72)
}
mm <- function (x) {
    return(x * 0.0393700787)
}
```

```{r}
write_images <- function (fig, name, height, width = mm(180), formats = c('png', 'svg')) {
    for (f in formats) {
        if (!f %in% c('png', 'svg', 'pdf', 'ps', 'eps')) {
            stop(paste0('Unknown format', f))
        }
        path <- paste0("./figs/", name, ".", f)
        ggsave(path, plot = fig, width = width, height = height, dpi = dpi, create.dir = TRUE)
    }
}
```

<!-- #region name="setup" tags=["remove_cell"] -->
## Load data from MIF files
<!-- #endregion -->

Loading the relevant scenario data from MIF files.

```{r}
mifdata1 <- read.quitte("inputdata/mif/REMIND_generic_TransitionwLockIn-NPi.mif")
mifdata2 <- read.quitte("inputdata/mif/REMIND_generic_TransitionwLockIn-PkBudg820.mif")
mifdata3 <- read.quitte("inputdata/mif/REMIND_generic_FastTransition-PkBudg820.mif")
```

## Combine and reduce to relevant variables


Combine data from three scenarios and filter for relevant steel production variables.

```{r}
df_data <- rbind(mifdata1, mifdata2, mifdata3) %>% filter(grepl("Production|Industry|Steel|+", variable, fixed = TRUE))
show_sample(df_data)
```

## MIP plot for reference


This should look just like the output from compareScenarios2.

```{r}
mip::showAreaAndBarPlots(
    df_data,
    as.character(unique(df_data$variable)),
    mainReg="World",
    yearsBarPlot=c(2010, 2030, 2050, 2100),
)
```

```{r}
mip::mipBarYearData(df_data)
```

## Process data before custom plotting


We perform the following actions on the data before plotting it manually:

* We map the 12 regions onto 6 regions.
* We simplify the variables by stripping of the `Production|Industry|Steel|+|` bit in the front.
* We reduce periods to relevant ones for plotting.
* We obtain the colour codes from MIP.

```{r}
region_groups <- list(
    CHA="China",
    IND="India",
    CAZ="REJUCAZ",
    EUR="REJUCAZ",
    JPN="REJUCAZ",
    LAM="Lat. America & Oth. Asia",
    MEA="Middle East & North. Africa",
    NEU="REJUCAZ",
    OAS="Lat. America & Oth. Asia",
    REF="REJUCAZ",
    SSA="Sub-Saharan Africa",
    USA="REJUCAZ",
    World="World"
)
```

```{r}
df_plot <- (
    df_data %>%
    mutate(region = recode(region, !!!region_groups)) %>%
    group_by(model, scenario, region, period, variable, unit) %>%
    summarise(value = sum(value)) %>%
    mutate(variable = sub("Production|Industry|Steel|+|", "", variable, fixed = TRUE)) %>%
    filter(period %in% c(2025, 2030, 2035, 2040, 2045, 2050, 2055, 2060, 2070))
)

# Sort variable by custom order.
df_plot$variable <- factor(df_plot$variable, levels = c('SCRAP-EAF', 'DRI-H2-EAF', 'DRI-NG-EAF-CCS', 'DRI-NG-EAF', 'BF-BOF-CCS', 'BF-BOF'))

show_sample(df_plot)
```

## Create new plot for Fig. 3


We create Figure 3 by combining one stacked-bar plot for the World with a facet of stacked-bar plots for the other regions in a grid.

```{r}
bar_spacing <- 0.5
bar_width_single <- 5 - bar_spacing
bar_width_double <- 10 - bar_spacing

scen_names <- list(
    "TransitionwLockIn-PkBudg820" = "Extended lock-in",
    "FastTransition-PkBudg820" = "Fast transition"
)
scen_shortnames <- list(
    "TransitionwLockIn-NPi" = "NPi",
    "TransitionwLockIn-PkBudg820" = "TwLI",
    "FastTransition-PkBudg820" = "FT"
)

ylab <- "Annual steel production (Mt/yr)"
```

```{r}
# Subfigures for World and 6 Regions for each scenario.
df_plot_grouped <- split(df_plot, df_plot$scenario)
subfigs_world <- list()
subfigs_regions <- list()

for (scen in names(df_plot_grouped)) {
  df_rows <- df_plot_grouped[[scen]]
  df_rows$period[df_rows$period == 2070] <- 2067.5

  # Subfigure for World.
  df_rows_world <- df_rows %>% filter(region == "World")
  subfigs_world[[scen]] <- ggplot(df_rows_world, aes(x = period, y = value, fill = variable)) +
    geom_col(width = ifelse(df_rows_world$period == 2067.5, bar_width_double, bar_width_single)) +
    facet_wrap(~ region) +
    labs(title = scen_names[[scen]], x = NULL, y = ylab) +
    theme_minimal() +
    theme(
      legend.position = "none",
      plot.title = element_text(size = 7, face = "bold"),
      axis.text.x = element_text(size = 5),
      axis.title.y = element_text(size = 6),
      axis.text.y = element_text(size = 5),
      strip.text.x = element_text(size = 6),
    ) +
    scale_fill_manual(
        values = plotstyle(as.character(levels(df_rows$variable))),
        name = NULL,
        labels = c(
            "Secondary steel using an electric arc\nfurnace (SCRAP-EAF)",
            "Primary steel using direct reduction of iron\nwith hydrogen and an electric arc furnace\n(DRI-H2-EAF)",
            "Primary steel using direct reduction of iron\nwith natural gas and an electric arc furnace\nwith carbon capture and storage (DRI-NG-EAF-CCS)",
            "Primary steel using direct reduction of iron\nwith natural gas and an electric arc furnace\n(DRI-NG-EAF)",
            "Primary steel using a blast furnace and a\nbasic oxygen furnace with carbon capture\nand storage (BF-BOF-CCS)",
            "Primary steel using a blast furnace and a\nbasic oxygen furnace (BF-BOF)"
        ),
    ) +
    guides(fill = guide_legend(nrow = 3, ncol = 2))

  # Subfigure through facet_wrap for all other regions.
  df_rows_regions <- df_rows %>% filter(region != "World")
  subfigs_regions[[scen]] <- ggplot(df_rows_regions, aes(x = period, y = value, fill = variable)) +
    geom_col(width = ifelse(df_rows_regions$period == 2067.5, bar_width_double, bar_width_single)) +
    facet_wrap(~ region, scales = "free_x", ncol = 2, strip.position = "top") +
    labs(title = NULL, x = NULL, y = NULL) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(size = 5),
      axis.text.y = element_text(size = 5),
      strip.text.x = element_text(size = 6),
      legend.title = element_text(size = 7),
      legend.text = element_text(size = 6),
      legend.position = NULL,
    ) +
    scale_fill_manual(
        values = plotstyle(as.character(levels(df_rows$variable))),
        name = NULL,
    )

    # Display subfigures plots.
    print(scen)
    show(subfigs_world[[scen]])
    show(subfigs_regions[[scen]])
  }
```

```{r}
# Subfigure comparing regions China and India across all scenarios.
df_rows_cha_ind <- df_plot %>%
    filter(region %in% c("China", "India")) %>%
    mutate(scenario=unlist(scen_shortnames)[scenario])
df_rows_cha_ind$scenario <- factor(df_rows_cha_ind$scenario, levels = c(unlist(scen_shortnames)))
subfig_cha_ind <- ggplot(df_rows_cha_ind, aes(x = scenario, y = value, fill = variable)) +
    geom_bar(stat = "identity") +
    # geom_col(width = ifelse(df_rows_regions$period == 2067.5, bar_width_double, bar_width_single)) +
    # facet_wrap(region ~ period, scales = "free_x", nrow=2, ncol = 9, strip.position = "top") +
    facet_grid(rows=vars(region), cols=vars(period)) +
    labs(title = NULL, x = NULL, y = ylab) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(size = 5),
      axis.text.y = element_text(size = 5),
      axis.title.y = element_text(size = 6),
      strip.text.x = element_text(size = 6),
      strip.text.y = element_text(size = 6),
      legend.title = element_text(size = 7),
      legend.text = element_text(size = 6),
      legend.position = "none",
    ) +
    scale_fill_manual(
        values = plotstyle(as.character(levels(df_rows$variable))),
        name = NULL,
        labels = c(
            "Secondary steel using an electric arc\nfurnace (SCRAP-EAF)",
            "Primary steel using direct reduction of iron\nwith hydrogen and an electric arc furnace\n(DRI-H2-EAF)",
            "Primary steel using direct reduction of iron\nwith natural gas and an electric arc furnace\nwith carbon capture and storage (DRI-NG-EAF-CCS)",
            "Primary steel using direct reduction of iron\nwith natural gas and an electric arc furnace\n(DRI-NG-EAF)",
            "Primary steel using a blast furnace and a\nbasic oxygen furnace with carbon capture\nand storage (BF-BOF-CCS)",
            "Primary steel using a blast furnace and a\nbasic oxygen furnace (BF-BOF)"
        ),
    )
show(subfig_cha_ind)
```

```{r}
# Subfigure comparing World for scenarios TwLI and FT.
df_rows_comp_world <- df_plot %>%
    filter(region == "World", scenario %in% c("TransitionwLockIn-PkBudg820", "FastTransition-PkBudg820")) %>%
    mutate(scenario=unlist(scen_shortnames)[scenario])
df_rows_comp_world$scenario <- factor(df_rows_comp_world$scenario, levels = c(unlist(scen_shortnames)))
subfig_comp_world <- ggplot(df_rows_comp_world, aes(x = scenario, y = value, fill = variable)) +
    geom_bar(stat = "identity") +
    # geom_col(width = ifelse(df_rows_regions$period == 2067.5, bar_width_double, bar_width_single)) +
    # facet_wrap(region ~ period, scales = "free_x", nrow=2, ncol = 9, strip.position = "top") +
    facet_grid(cols=vars(period)) +
    labs(title = NULL, x = NULL, y = ylab) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(size = 5),
      axis.text.y = element_text(size = 5),
      axis.title.y = element_text(size = 6),
      strip.text.x = element_text(size = 6),
      strip.text.y = element_text(size = 6),
      legend.title = element_text(size = 7),
      legend.text = element_text(size = 6),
      legend.position = "none",
    ) +
    scale_fill_manual(
        values = plotstyle(as.character(levels(df_rows$variable))),
        name = NULL,
    )
show(subfig_comp_world)
```

```{r}
# Fig. 3 (old)
fig <- ggarrange(
    subfigs_world[["TransitionwLockIn-PkBudg820"]],
    subfigs_regions[["TransitionwLockIn-PkBudg820"]],
    subfigs_world[["FastTransition-PkBudg820"]],
    subfigs_regions[["FastTransition-PkBudg820"]],
    ncol=2,
    nrow=2,
    common.legend = TRUE,
    legend="bottom"
)
write_images(fig, "Fig3old", height = mm(180))
show(fig)
```

```{r}
# Fig. 3 (Option 1)
fig <- ggarrange(
    subfigs_world[["TransitionwLockIn-PkBudg820"]],
    subfigs_world[["FastTransition-PkBudg820"]],
    subfigs_regions[["FastTransition-PkBudg820"]],
    subfig_cha_ind,
    ncol=2,
    nrow=2,
    common.legend = TRUE,
    legend="bottom"
)
write_images(fig, "Fig3opt1", height = mm(180))
show(fig)
```

```{r}
# Fig. 3 (Option 2)
fig <- ggarrange(
    ggarrange(
        subfigs_world[["FastTransition-PkBudg820"]],
        subfigs_regions[["FastTransition-PkBudg820"]],
        ncol=2,
        nrow=1,
        legend="none"
    ),
    subfig_cha_ind,
    ncol=1,
    nrow=2,
    common.legend = TRUE,
    legend = "bottom"
)
write_images(fig, "Fig3opt2", height = mm(180))
show(fig)
```

```{r}
# Fig. 3 (Option 2b)
fig <- ggarrange(
    ggarrange(
        subfig_comp_world,
        subfigs_regions[["FastTransition-PkBudg820"]],
        ncol=2,
        nrow=1,
        legend="none"
    ),
    subfig_cha_ind,
    ncol=1,
    nrow=2,
    common.legend = TRUE,
    legend = "bottom"
)
write_images(fig, "Fig3opt2b", height = mm(180))
show(fig)
```
